---
title: "Preprocess Reference Expression data for Web App"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preprocess Reference Expression data for Web App}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "vignettes/figures/preprocess-reference-",
  out.width = "100%"
)
```

This vignette demonstrates how to preprocess your own perturb-seq pilot data for use with the PerturbPlan web application and power analysis functions.

```{r setup}
library(perturbplan)
```

## Overview

PerturbPlan requires three types of information from pilot data for power analysis:

1. **Baseline Expression Statistics**: Gene-level expression parameters (mean and dispersion) fitted from a negative binomial model
2. **Library Parameters**: Read-to-UMI saturation curve parameters (UMI_per_cell and variation) that characterize library preparation and PCR amplification bias
3. **Mapping Efficiency**: Proportion of reads that map to the transcriptome we're interested in

This preprocessing workflow consists of two main steps:

1. **`reference_data_preprocessing_10x()`**: Load raw data from multiple SRR runs of raw Cell Ranger outputs and aggregate them into a list containing:
   - Gene-by-cell expression matrix
   - UMI-level molecule information dataframe
   - Naive estimate of mapping efficiency (proportion of reads mapped to the whole transcriptome among all reads)
2. **`reference_data_processing()`**: Fits statistical models with the aggregated data from Step 1 to extract parameters needed for power analysis

## Step 1: Aggregate Cell Ranger Outputs

The `reference_data_preprocessing_10x()` function aggregates Cell Ranger outputs from multiple sequencing runs (SRRs) into a single data structure.

### Input Requirements

Your data should be organized with Cell Ranger output directories under a top-level folder:

```
path_to_top_level_output/
├── SRR_run_1/
│   ├── filtered_feature_bc_matrix/
│   │   ├── barcodes.tsv.gz
│   │   ├── features.tsv.gz
│   │   └── matrix.mtx.gz
│   ├── molecule_info.h5
│   └── metrics_summary.csv
├── SRR_run_2/
│   └── ...
└── SRR_run_3/
    └── ...
```

Your SRR directories should be generated by a recent version of Cell Ranger configured for the perturbation (CRISPR or Perturb-seq) workflow.
In addition, each metrics_summary.csv file must include a column named Number of Reads, which is required to estimate mapping efficiency.
This column may need to be added or edited manually when Cell Ranger is run with custom guide libraries.

For more information about input format and required fields, see `?obtain_qc_response_data`, `?obtain_qc_read_umi_table`, and `?obtain_mapping_efficiency`. Also, these three functions can also be used individually to generate each component of the output produced by `reference_data_preprocessing_10x()`.

### Function Usage

There's an example SRR folder called `cellranger_tiny` under thefolder `extdata` in our package, and we'll use that for demonstration:

```{r}
# Point to directory containing example Cell Ranger outputs
extdata_path <- system.file("extdata", package = "perturbplan")

# Aggregate data from all SRR runs
raw_data <- reference_data_preprocessing_10x(
  path_to_top_level_output = extdata_path,
  path_to_run_level_output = "cellranger_tiny",  # Only read subfolder cellranger_tiny 
  h5_rough = TRUE,  # Use first SRR for QC data (faster)
  skip_mapping_efficiency = FALSE  # Estimate mapping efficiency
)
```

**Arguments:**

- `path_to_top_level_output`: Path to directory containing Cell Ranger run-level subdirectories
- `path_to_run_level_output`: Optional character vector specifying subset of run directories to process
- `h5_rough`: If `TRUE` (default), extracts the UMI-level molecule information dataframe from first SRR only for speed. If `FALSE`, combines UMI-level molecule information from all SRRs
- `skip_mapping_efficiency`: If `TRUE`, skips estimation of mapping efficiency. If `FALSE` (default), calculates naive mapping efficiency using data from a properly formatted `metrics_summary.csv` file as described above.


### Function Output

```{r}
# Inspect structure
str(raw_data)
```
**Format of each output:**

- `response_matrix`: a sparse gene-by-cell expression matrix (genes as rows, cells as columns) with row and column names
- `read_umi_table`: a data frame with UMI-level molecule information, including columns:
  - `num_reads`: Number of reads supporting this UMI-cell combination
  - `UMI_id`: UMI index of this UMI-cell combination
  - `cell_id`: Cell barcode of this UMI-cell combination
  - `response_id`: Gene identifier (e.g., Ensembl ID)
  - `srr_idx`: SRR run identifier of the UMI
- `mapping_efficiency`: A numeric value between 0 and 1 if `skip_mapping_efficiency = FALSE`, and NULL if `skip_mapping_efficiency = TRUE`

## Step 2: Extract Statistical Parameters

The `reference_data_processing()` function fits statistical models to extract gene-level expression parameters, library parameters and more sophisticated mapping efficiency required by PerturbPlan.

### Statistical Models

#### Gene Expression Model (Negative Binomial)

For each gene, the function fits a negative binomial (NB) model to characterize the distribution of gene expression levels across cells:

$$\text{gene_expression} \sim \text{NB}(\text{mean} = \text{library_size} \times \text{relative_expression}, \text{size} = \text{expression_size})$$

where

- `gene_expression`: Number of observed UMIs for the gene in each cell
- `library_size`: Total UMI count per cell

are the data to use, and

- `relative_expression`: Relative expression level of the gene (fitted parameter)
- `expression_size`: Dispersion parameter (small values indicate high biological variability)

are the fitted parameters.

#### Sequencing Saturation Model (S-M Curve)

The function fits a saturation (S-M) curve that relates mapped reads per cell to observed UMIs per cell:

$$\text{UMI} = \text{total_UMIs} \times \left(1 - \exp\left(-\frac{\text{reads}}{\text{total_UMIs}}\right) \times \left(1 + \text{variation} \times \frac{\text{reads}^2}{2 \times \text{total_UMIs}^2}\right)\right)$$

where

- `reads`: Number of mapped reads per cell
- `UMI`: Number of observed UMIs per cell

are the data to use, and

- `total_UMIs` (UMI_per_cell): Maximum UMI per cell parameter at sequencing saturation
- `variation`: Variation parameter characterizing PCR amplification bias (between 0 and 1)

are the fitted parameters.

### Function Usage

```{r}
# Set seed for reproducibility
set.seed(123)

# Process into final pilot data format with all genes, suitable for perturb-seq experimental design
pilot_data_perturbseq <- reference_data_processing(
  response_matrix = raw_data$response_matrix,
  read_umi_table = raw_data$read_umi_table,
  mapping_efficiency = raw_data$mapping_efficiency,
  gene_list = NULL,     # Use all genes
  TPM_thres = 0.1,      # Default expression threshold for filtering
  downsample_ratio = 1:9/10,  # Default downsampling for sequencing
  D2_rough = 0.4,       # Default prior for variation parameter
  h5_only = FALSE,      # Set TRUE to skip expression fitting
  n_threads = NULL      # No parallel processing
)

# Process into pilot data format with targetd genes only, suitable for TAP-seq experimental design
gene_list <- c("ENSG00000241860", "ENSG00000238009", "ENSG00000239945")
pilot_data_tapseq <- reference_data_processing(
  response_matrix = raw_data$response_matrix,
  read_umi_table = raw_data$read_umi_table,
  mapping_efficiency = raw_data$mapping_efficiency,
  gene_list = gene_list, # Restrict to specific genes
  TPM_thres = 0.         # No expression threshold for filtering
)
```

**Arguments:**

- `response_matrix`: Gene-by-cell expression matrix from Step 1 (or NULL if `h5_only = TRUE`)
- `read_umi_table`: QC data frame from Step 1
- `mapping_efficiency`: Mapping efficiency from Step 1
- `gene_list`: Optional character vector to restrict analysis to specific genes
- `TPM_thres`: Threshold for filtering low-expression genes in gene expression model (default: 0.1)
- `downsample_ratio`: Proportion of downsampling in library saturation model fitting (default: 0.7)
- `D2_rough`: Prior value for variation parameter in library saturation model (default: 0.3)
- `h5_only`: If `TRUE`, skips baseline expression step to save time, useful when you're trying to find sensible hyperparameters for library model fitting (default: FALSE)
- `n_threads`: Number of parallel processing threads (default: NULL for single-threaded)

**Returns:**

A list with three elements:

- `baseline_expression_stats`: Data frame with columns:
  - `response_id`: Gene identifiers
  - `relative_expression`: Fitted relative expression levels (TPM/1e6 scale)
  - `expression_size`: Fitted dispersion parameters
- `library_parameters`: List with:
  - `UMI_per_cell`: Estimated maximum UMI count per cell
  - `variation`: Estimated PCR amplification variation parameter
- `mapping_efficiency`: Updated mapping efficiency accounting for gene filtering


### Function Output

```{r}
# Inspect structure of perturb-seq pilot data
str(pilot_data_perturbseq)

# Inspect structure of TAP-seq pilot data
str(pilot_data_tapseq)
```

## See Also

- `?reference_data_preprocessing_10x`: Detailed function documentation
- `?reference_data_processing`: Detailed function documentation
- `?library_estimation`: Library parameter estimation details
- `?obtain_expression_information`: Expression parameter fitting details
- Vignette "Getting Started with PerturbPlan": Overview of power analysis workflow
