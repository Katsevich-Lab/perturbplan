---
title: "PerturbPlan: power analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PerturbPlan: power analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette is meant to showcase the functionality of `compute_power()`. 

We first load the `PerturbPlan` package and the gene expression data for illustration. 

```{r setup}
# load necessary packages
library(perturbplan)
# load gene expression data 
gene_expression <- readRDS("gene_expression_summary.rds")
```

## Compute the perturbed cells for each gRNA in each gRNA group targeting for the same element

We define the treatment and control cells for each target element. Here we consider $2$ elements with $2$ gRNAs targeting each element. Each of these gRNAs is allocated respectively with $500$ cells. 

```{r}
# Specify number of elements, gRNA per element and cell per gRNA
num_element <- 2
gRNA_per_element <- 2
cell_per_gRNA <- 500

# specify gRNA target set
gRNA_target_set <- sprintf("enh%d", 1:num_element)

# specify gRNA id set
gRNA_id_set <- sprintf("gRNA%d", 1:gRNA_per_element)

# Define treatment cell data frame
target_cell_df <- data.frame(
  gRNA_id = rep(gRNA_id_set, times = num_element),
  gRNA_target = rep(gRNA_target_set, each = gRNA_per_element),
  num_cells = rep(cell_per_gRNA, num_element * gRNA_per_element)
)
target_cell_df
```

## Compute the number of control cells for each enhancer of interest

We assume each cell receives only one gRNA so each element get $500\times 2=1000$ cells receiving the perturbation targeting on the element. The number of control cells in each enhancer-gene test pair is just $50000-1000=49000$, where $50000$ is the total number of cells.

```{r}
# Define the total number of cells
num_total_cells <- 50000

# Define control cell vector
control_cell_vec <- setNames(num_total_cells - rep(cell_per_gRNA * gRNA_per_element, num_element), gRNA_target_set)

control_cell_vec
```

## Specify mean and size parameter for NB distribution in control cell group

We will specify the mean expression and size parameter for each gene of interest from the gene_expression data.frame. 

```{r}
# specify gene set
gene_set <- gene_expression$ensembl

# Specify mean expression
baseline_expression <- setNames(gene_expression$mean, gene_set)
head(baseline_expression)

# Specify size paramter
size_parameter <- setNames(1 / gene_expression$dispersion, gene_set)
head(size_parameter)

# compute the total number of genes of interest
num_gene <- length(gene_set)
num_gene

```

## Specify mean and sd effect size matrices

Specify the mean and sd of effect size for each enhancer-gene pair.

```{r}
# mean effect size matrix
mean_fold_change <- 0.85
effect_size_mean <- matrix(mean_fold_change, nrow = num_element, ncol = num_gene, dimnames = list(
  gRNA_target = gRNA_target_set,
  gene = gene_set
))
effect_size_mean[1:2,1:2]

# sd effect size matrix
sd_fold_change <- 0.13
effect_size_sd <- matrix(sd_fold_change, nrow = num_element, ncol = num_gene, dimnames = list(
  gRNA_target = gRNA_target_set,
  gene = gene_set
))
effect_size_sd[1:2,1:2]

```

## Specify QC-related parameters

Last, specify quality-control related parameters: `QC`, `n_nonzero_trt`, `n_nonzero_ctl` and p-value cutoff: `cutoff`.


```{r}

# n_nonzero_trt and n_nonzero_ctl
n_nonzero_trt_thresh <- 7
n_nonzero_cntrl_thresh <- 7

```

## Specify test-related parameters and p-value cutoff

```{r}
# specify the cutoff
cutoff <- 1e-3

# sideness of the test
side <- "both"

```

## Finally, compute power for each enhancer-gene pair

```{r}
# use compute_power()
power_results <- compute_power(
  control_cell_vec = control_cell_vec,
  target_cell_df = target_cell_df,
  baseline_expression = baseline_expression,
  size_parameter = size_parameter,
  effect_size_mean = effect_size_mean,
  effect_size_sd = effect_size_sd,
  n_nonzero_trt_thresh = n_nonzero_trt_thresh,
  n_nonzero_cntrl_thresh = n_nonzero_cntrl_thresh,
  side = side,
  cutoff = cutoff,
  intermediate_outcome = FALSE
)

# plot the histogram of computed power for each pair
hist(power_results$individual_power$adjusted_power,
     main = "Power histogram",
     xlab = "Power")

```

## Another way to specify the mean and sd of fold changes

Sometimes, one would want to use the same scalar for the mean and sd fold changes of all enhancer-gene pairs (as we were in the previous example), we can just use the values `mean_fold_change` and `sd_fold_change` without creating a matrix with the same value in all entries.

```{r}
# use compute_power()
power_results <- compute_power(
  control_cell_vec = control_cell_vec,
  target_cell_df = target_cell_df,
  baseline_expression = baseline_expression,
  size_parameter = size_parameter,
  effect_size_mean = mean_fold_change,
  effect_size_sd = sd_fold_change,
  n_nonzero_trt_thresh = n_nonzero_trt_thresh,
  n_nonzero_cntrl_thresh = n_nonzero_cntrl_thresh,
  side = side,
  cutoff = cutoff,
  intermediate_outcome = FALSE
)

# plot the histogram of computed power for each pair
hist(power_results$individual_power$adjusted_power,
     main = "Power histogram",
     xlab = "Power")

```

```{r}
discovery_pairs <- power_results$individual_power |> 
  tidyr::separate(pair, into = c("grna_target", "response_id"), sep = "_") |>
  dplyr::select(-adjusted_power)

cells_per_grna <- target_cell_df |>
  dplyr::rename(grna_id = gRNA_id, grna_target = gRNA_target)

baseline_expression_stats <- gene_expression |>
  dplyr::rename(response_id = ensembl, expression_mean = mean) |>
  dplyr::mutate(expression_size = 1 / dispersion) |>
  dplyr::select(response_id, expression_mean, expression_size)

control_group <- "complement"

effect_size_mean <- mean_fold_change
effect_size_sd <- sd_fold_change
```
