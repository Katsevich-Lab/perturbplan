% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/power_posthoc.R
\name{compute_power_posthoc}
\alias{compute_power_posthoc}
\title{Compute power for each perturbation-gene pair}
\usage{
compute_power_posthoc(
  discovery_pairs,
  cells_per_grna,
  baseline_expression_stats,
  control_group,
  fold_change_mean,
  fold_change_sd,
  num_total_cells = NULL,
  cutoff = NULL,
  n_nonzero_trt_thresh = 7L,
  n_nonzero_cntrl_thresh = 7L,
  side = "both",
  multiple_testing_method = "BH",
  multiple_testing_alpha = 0.1
)
}
\arguments{
\item{discovery_pairs}{A data frame specifying which element-gene pairs to consider, with columns \code{grna_target} and \code{response_id}}

\item{cells_per_grna}{A data frame specifying how many cells contain each gRNA, with columns \code{grna_id}, \code{grna_target}, and \code{num_cells}}

\item{baseline_expression_stats}{A data frame specifying the baseline expression statistics for each gene, with columns \code{response_id}, \code{expression_mean}, and \code{expression_size}}

\item{control_group}{A character string specifying the control group, either "complement" or "nt_cells"}

\item{fold_change_mean}{A numeric value to use for mean effect size for all element-gene pairs}

\item{fold_change_sd}{A numeric value to use for standard deviation of effect size for all element-gene pairs}

\item{num_total_cells}{(Required only if control_group == "complement") A positive integer specifying the total number of cells in the experiment}

\item{cutoff}{(Optional) A numeric value between 0 and 1 to use as the p-value cutoff}

\item{n_nonzero_trt_thresh}{(Optional) An integer specifying the sceptre QC parameter of the same name; defaults to 7}

\item{n_nonzero_cntrl_thresh}{(Optional) An integer specifying the sceptre QC parameter of the same name; defaults to 7}

\item{side}{(Optional) A character string specifying the side of the test, either "left", "right", or "both"; defaults to "both"}

\item{multiple_testing_method}{(Optional) A character string specifying the multiple testing correction method to use, either "BH" or "bonferroni"; defaults to "BH"}

\item{multiple_testing_alpha}{(Optional) A numeric value between 0 and 1 specifying the alpha level for multiple testing correction; defaults to 0.1}
}
\value{
A list with two elements: \code{individual_power} (a data frame with columns \code{grna_target}, \code{response_id}, and \code{power}) and \code{expected_num_discoveries} (a numeric value)
}
\description{
Compute power for each perturbation-gene pair
}
\examples{
## --- Toy perturb-seq dataset setup ---
# Total number of cells in the experiment
num_total_cells <- 1000L

# Number of cells receiving each gRNA
# (3 enhancers Ã— 2 gRNAs each + 2 non-targeting gRNAs)
cells_per_grna <- data.frame(
  grna_id      = c("enh1_grna1","enh2_grna1","enh3_grna1","nt_grna1",
                   "enh1_grna2","enh2_grna2","enh3_grna2","nt_grna2"),
  grna_target  = c("enh1","enh2","enh3","non-targeting",
                   "enh1","enh2","enh3","non-targeting"),
  num_cells    = c(93L,113L,112L,104L,84L,104L,107L,105L),
  stringsAsFactors = FALSE
)

# Baseline expression statistics (negative binomial mean and size per gene)
baseline_expression_stats <- data.frame(
  response_id       = paste0("gene", 1:4),
  expression_mean   = c(2.002931, 12.326867, 4.014221, 1.460472),
  expression_size   = c(0.2967991, 8.3723191, 2.5988431, 2.6746265),
  stringsAsFactors = FALSE
)

# Discovery pairs: test 3 enhancers against 4 genes
discovery_pairs <- within(expand.grid(
  grna_target = c("enh1","enh2","enh3"),
  response_id = paste0("gene", 1:4),
  KEEP.OUT.ATTRS = FALSE, stringsAsFactors = FALSE
), { grna_target <- as.character(grna_target); response_id <- as.character(response_id) })

## --- Analysis choices ---
control_group <- "complement"          # use complement control group
side <- "left"                         # left-sided test
n_nonzero_trt_thresh   <- 7L            # min. nonzero counts in treatment
n_nonzero_cntrl_thresh <- 7L            # min. nonzero counts in control

## --- Power analysis parameters ---
fold_change_mean <- 0.85                # expected mean fold change
fold_change_sd   <- 0.13                # expected SD of fold change
cutoff <- 0.005                         # significance threshold (p-value cutoff)

## --- Run PerturbPlan posthoc power analysis ---
power_results <- compute_power_posthoc(
  num_total_cells = num_total_cells,
  cells_per_grna = cells_per_grna,
  baseline_expression_stats = baseline_expression_stats,
  discovery_pairs = discovery_pairs,
  control_group = control_group,
  side = side,
  n_nonzero_trt_thresh = n_nonzero_trt_thresh,
  n_nonzero_cntrl_thresh = n_nonzero_cntrl_thresh,
  fold_change_mean = fold_change_mean,
  fold_change_sd = fold_change_sd,
  cutoff = cutoff
)

# Inspect outputs
names(power_results)                    # available fields
power_results$expected_num_discoveries  # expected number of discoveries
head(power_results$individual_power)    # power per enhancer-gene pair

}
