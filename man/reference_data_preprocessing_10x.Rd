% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pilot_data_preprocessing.R
\name{reference_data_preprocessing_10x}
\alias{reference_data_preprocessing_10x}
\title{Aggregate Expression and QC Data from Multiple SRR-Level Cell Ranger Outputs}
\usage{
reference_data_preprocessing_10x(
  path_to_top_level_output,
  path_to_run_level_output = NULL,
  h5_rough = TRUE
)
}
\arguments{
\item{path_to_top_level_output}{Character. Path to the top-level directory
containing Cell Ranger run-level subdirectories.}

\item{path_to_run_level_output}{Optional character vector. A subset of run-level
directory names (not full paths). These should match the basename of folders
inside \code{path_to_top_level_output}. Unmatched entries will trigger a warning.}

\item{h5_rough}{Logical. If TRUE (default), h5 data will only be extracted from
the first SRR folder. If FALSE, data from all SRRs will be combined.}
}
\value{
A list with two elements:
\describe{
\item{response_matrix}{A matrix of gene expression values (common genes only),
combined across SRR directories.}
\item{read_umi_table}{A data frame of molecule-level QC data from one or more SRRs,
including the SRR label.}
\item{mapping_efficiency}{A numeric value representing the mapping efficiency}
}
}
\description{
This function aggregates gene expression matrices and h5 molecule-level data
from multiple SRR-level Cell Ranger output directories. It aligns all matrices
to a common set of genes, performs basic consistency checks, and optionally
restricts to a user-defined subset of run-level directories.
}
\details{
The function performs the following steps:
\enumerate{
\item Lists all SRR directories under the given top-level folder.
\item Optionally filters to a subset of run-level names.
\item Reads response matrices and retains only shared genes across SRRs.
\item Optionally reads h5 QC data from one or all SRRs.
}

\strong{Library Saturation (S-M) Model:}

The function extracts QC data that is subsequently used to fit a saturation-magnitude (S-M)
curve model that relates mapped reads per cell to observed UMIs per cell. This model is
essential for library size estimation in single-cell RNA sequencing power analysis.

The S-M curve model follows the nonlinear saturation formula:
\deqn{UMI = total\_UMIs \times \left(1 - \exp\left(-\frac{reads}{total\_UMIs}\right) \times \left(1 + variation \times \frac{reads^2}{2 \times total\_UMIs^2}\right)\right)}

Where:
\itemize{
\item \code{total_UMIs}: Maximum UMI per cell parameter (saturation level)
\item \code{variation}: Variation parameter characterizing PCR amplification bias
\item \code{reads}: Number of mapped reads per cell
\item \code{UMI}: Number of observed UMIs per cell
}

The model accounts for both UMI saturation effects at high read depths and
PCR amplification variability, enabling accurate power calculations across
different sequencing scenarios.
}
\examples{
# Process tiny example dataset
extdata_path <- system.file("extdata", package = "perturbplan")
# Note: This is a minimal example dataset for testing
result <- reference_data_preprocessing_10x(
  path_to_top_level_output = extdata_path,
  path_to_run_level_output = "cellranger_tiny",
  h5_rough = TRUE
)

# Inspect structure
str(result)

# Access components
result$response_matrix

}
\seealso{
\code{\link{library_computation}} for S-M curve fitting details

\code{\link{obtain_qc_response_data}}, \code{\link{obtain_qc_read_umi_table}}
}
