<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • perturbplan</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"><meta property="og:image" content="https://katsevich-lab.github.io/perturbplan/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">perturbplan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="reference/index.html">Functions</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/preprocess-reference.html">Prepare Data For Web App</a>
    <a class="dropdown-item" href="articles/prospective-power.html">Prospective Power Analysis</a>
    <a class="dropdown-item" href="articles/posthoc.html">Retrospective Power Analysis</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://katsevich-lab-perturbplan.share.connect.posit.cloud/">
    <span class="fa fa-external-link-alt"></span>
     
    Web App
  </a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Katsevich-Lab/perturbplan" aria-label="GitHub repository">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>CLAUDE.md</h1>
      
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p>PerturbPlan is an R package for experimental design and power analysis for perturb-seq experiments (CRISPR-based single-cell perturbation experiments). It combines R and C++ code for efficient statistical computations.</p>
</div>
<div class="section level2">
<h2 id="common-development-commands">Common Development Commands<a class="anchor" aria-label="anchor" href="#common-development-commands"></a></h2>
<div class="section level3">
<h3 id="build-and-check">Build and Check<a class="anchor" aria-label="anchor" href="#build-and-check"></a></h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Build the package</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">R</span> CMD build .</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># Check the package (replace version as needed)</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="ex">R</span> CMD check perturbplan_0.0.1.tar.gz</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># Install the package locally</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL .</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="development-workflow">Development Workflow<a class="anchor" aria-label="anchor" href="#development-workflow"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load package during development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run all tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run a specific test file</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"test-library_computation"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate documentation from roxygen2 comments</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">document</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check package without building</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">check</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="shiny-app">Shiny App<a class="anchor" aria-label="anchor" href="#shiny-app"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Launch the interactive app (runs app.R)</span></span>
<span><span class="fu">perturbplan</span><span class="fu">::</span><span class="fu">launch_app</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="core-components">Core Components<a class="anchor" aria-label="anchor" href="#core-components"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Power Analysis Pipeline</strong> (<code>R/power_plan.R</code>, <code>R/plan_help.R</code>)
<ul><li>
<code>calculate_power_grid()</code>: Main function for heatmap power analysis<br></li>
<li>
<code>compute_power_grid_efficient()</code>: Efficient grid-based power analysis using C++ Monte Carlo</li>
<li>
<code><a href="reference/compute_power_posthoc.html">compute_power_posthoc()</a></code>: Main function for post-hoc power analysis</li>
<li>Integrates with C++ implementations for performance</li>
</ul></li>
<li>
<strong>Parameter Estimation</strong> (<code>R/parameter_estimation.R</code>, <code>R/parameter_estimation_help.R</code>)
<ul><li>
<code><a href="reference/library_estimation.html">library_estimation()</a></code>: Estimates parameters from existing data</li>
<li>
<code><a href="reference/library_computation.html">library_computation()</a></code>: Computes QC-aware library statistics</li>
</ul></li>
<li>
<strong>C++ Performance Layer</strong> (<code>src/</code>)
<ul><li>
<code>BH_cutoff.cpp</code>: Benjamini-Hochberg multiple testing corrections</li>
<li>
<code>compute_distribution_teststat_*.cpp</code>: Test statistic distributions</li>
<li>
<code>power_curves.cpp</code>: Monte Carlo integration for power curves</li>
<li>Key C++ functions: <code><a href="reference/compute_monte_carlo_teststat_cpp.html">compute_monte_carlo_teststat_cpp()</a></code>, <code>compute_fc_curve_cpp()</code>, <code>compute_expression_curve_cpp()</code>
</li>
<li>Uses Rcpp for seamless R/C++ integration</li>
</ul></li>
<li>
<strong>Quality Control</strong> (<code>R/QC_computation.R</code>)
<ul><li>Implements pairwise QC checks for perturb-seq data</li>
<li>Filters based on minimum non-zero cell counts</li>
</ul></li>
<li>
<strong>Input Validation</strong> (<code>R/check.R</code>)
<ul><li>Comprehensive validation functions for all major operations</li>
<li>Ensures data consistency across the pipeline</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="data-flow">Data Flow<a class="anchor" aria-label="anchor" href="#data-flow"></a></h3>
<ol style="list-style-type: decimal"><li>User provides:
<ul><li>Cell counts per gRNA</li>
<li>Baseline expression statistics</li>
<li>Perturbation-gene pairs to analyze (Random mode or Custom CSV with <code>grna_target</code>, <code>response_id</code> columns)</li>
<li>Analysis parameters (control group, test side, QC thresholds)</li>
</ul></li>
<li>The package:
<ul><li>Validates inputs and CSV format (if Custom mode)</li>
<li>Handles gene multiplicity using weighted sampling for duplicate genes in pairs</li>
<li>Computes QC-aware library sizes</li>
<li>Calculates test statistic distributions using C++</li>
<li>Estimates power for each perturbation-gene pair</li>
</ul></li>
<li>Returns:
<ul><li>Individual power for each pair</li>
<li>Expected total discoveries</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="key-design-decisions">Key Design Decisions<a class="anchor" aria-label="anchor" href="#key-design-decisions"></a></h3>
<ul><li>
<strong>Rcpp Integration</strong>: C++ code handles computationally intensive operations (distribution calculations, multiple testing corrections)</li>
<li>
<strong>Modular Design</strong>: Separate functions for parameter estimation, QC computation, and power analysis allow flexible workflows</li>
<li>
<strong>Shiny Interface</strong>: Provides non-programmatic access via <code>inst/shiny/app.R</code>
</li>
<li>
<strong>C++ Optimization</strong>: Monte Carlo loops implemented in C++ for significant performance improvements</li>
<li>
<strong>Weighted Sampling</strong>: Preserves gene multiplicity from perturbation-gene pairs using efficient weighted sampling instead of row duplication</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a></h2>
<p>The package has been optimized for computational efficiency:</p>
<ul><li>
<strong>C++ Monte Carlo</strong>: <code>.compute_power_plan_efficient()</code> replaces the older R-based <code>.compute_underspecified_power_efficient()</code> with C++ implementations</li>
<li>
<strong>Batch Processing</strong>: Monte Carlo samples processed in batch using <code><a href="reference/compute_monte_carlo_teststat_cpp.html">compute_monte_carlo_teststat_cpp()</a></code>
</li>
<li>
<strong>Efficient Curves</strong>: Power curves computed using optimized C++ functions (<code>compute_fc_curve_cpp</code>, <code>compute_expression_curve_cpp</code>)</li>
<li>
<strong>Memory-Efficient Sampling</strong>: Uses weighted sampling for gene multiplicity instead of duplicating rows, reducing memory usage while preserving statistical correctness</li>
</ul></div>
<div class="section level2">
<h2 id="shiny-application-features">Shiny Application Features<a class="anchor" aria-label="anchor" href="#shiny-application-features"></a></h2>
<div class="section level3">
<h3 id="perturbation-gene-pairs-analysis">Perturbation-Gene Pairs Analysis<a class="anchor" aria-label="anchor" href="#perturbation-gene-pairs-analysis"></a></h3>
<p>The Shiny app provides an intuitive interface for specifying perturbation-gene pairs:</p>
<ul><li>
<strong>Random Mode</strong>: Randomly samples genes from the baseline expression dataset</li>
<li>
<strong>Custom Mode</strong>: Accepts CSV files with user-specified perturbation-gene pairs
<ul><li>Required format: CSV with <code>grna_target</code> and <code>response_id</code> columns</li>
<li>
<code>response_id</code> must contain Ensembl gene IDs (e.g., ENSG00000141510)</li>
<li>Preserves gene multiplicity: genes appearing in multiple pairs get proportional weight in power calculations</li>
<li>Example file: <code>inst/extdata/sample_pairs.csv</code>
</li>
</ul></li>
</ul></div>
<div class="section level3">
<h3 id="ui-organization">UI Organization<a class="anchor" aria-label="anchor" href="#ui-organization"></a></h3>
<p>The application features a streamlined two-tab structure:</p>
<ol style="list-style-type: decimal"><li>
<strong>Overall Power</strong>: Unified tab with sub-tabs for “Heatmap” and “Slice” views</li>
<li>
<strong>Drill-down Power</strong>: Detailed power curve analysis for selected experimental conditions</li>
</ol><p>Analysis choices are ordered for logical workflow: 1. <strong>Perturbation-gene pairs to analyze</strong>: Random/Custom dropdown 2. <strong>Minimum TPM threshold</strong>: Gene expression filtering 3. <strong>Test side</strong>: Left (knockdown), Right (overexpression) 4. <strong>Control group</strong>: Complement cells vs Non-targeting cells<br>
5. <strong>FDR target level</strong>: Multiple testing correction threshold</p>
</div>
<div class="section level3">
<h3 id="power-visualization-interface">Power Visualization Interface<a class="anchor" aria-label="anchor" href="#power-visualization-interface"></a></h3>
<div class="section level4">
<h4 id="overall-power-tab">Overall Power Tab<a class="anchor" aria-label="anchor" href="#overall-power-tab"></a></h4>
<ul><li>
<strong>Heatmap Sub-tab</strong>: Interactive power heatmap with click-to-select functionality
<ul><li>Drill-down controls for cells, reads per cell, or both (tiles)</li>
<li>Context-sensitive sidebar showing only relevant controls</li>
</ul></li>
<li>
<strong>Slice Sub-tab</strong>: Line plots showing power curves for selected heatmap slices
<ul><li>Conditional display: shows instruction message when no slices selected</li>
<li>Interactive point selection with multiple selection support</li>
</ul></li>
</ul></div>
<div class="section level4">
<h4 id="drill-down-power-tab">Drill-down Power Tab<a class="anchor" aria-label="anchor" href="#drill-down-power-tab"></a></h4>
<p>Provides detailed power curve analysis with:</p>
<ul><li>
<strong>Tabbed Interface</strong>: Separate tabs for “Expression” and “Fold Change” plots</li>
<li>
<strong>Display Options</strong>: Control box with three visualization modes:
<ul><li>“All together”: All experimental designs on a single plot with:
<ul><li>Color representing number of cells</li>
<li>Linetype and point shape representing reads per cell</li>
<li>Legends positioned on the right for optimal space usage</li>
<li>Clean legend labels (no redundant “reads/cell” text)</li>
</ul></li>
<li>“Facet over cells”: Horizontal panels separated by cell count, colored by reads per cell</li>
<li>“Facet over reads per cell”: Horizontal panels separated by reads per cell, colored by cell count</li>
</ul></li>
<li>
<strong>Interactive Features</strong>:
<ul><li>ggside marginal histograms showing distribution of expression/fold change values</li>
<li>Points added to all line plots for better data visibility</li>
<li>Square aspect ratio panels for optimal viewing</li>
<li>Consistent 570px box heights across all tabs</li>
</ul></li>
<li>
<strong>Performance Optimization</strong>: Default 10×10 grid (instead of 20×20) for faster computation</li>
</ul></div>
</div>
<div class="section level3">
<h3 id="file-validation">File Validation<a class="anchor" aria-label="anchor" href="#file-validation"></a></h3>
<ul><li>Validates CSV format and required columns</li>
<li>Provides clear error messages for format issues</li>
<li>Shows loading status: “Loaded X pairs (Y unique genes)”</li>
<li>Warns about genes filtered out due to low TPM</li>
</ul></div>
<div class="section level3">
<h3 id="excel-download-organization">Excel Download Organization<a class="anchor" aria-label="anchor" href="#excel-download-organization"></a></h3>
<p>The results Excel file is organized with numbered sheets for logical reading:</p>
<ol style="list-style-type: decimal"><li>
<strong>1_Parameters</strong>: Analysis settings and input parameters</li>
<li>
<strong>2_Power_Grid</strong>: Main heatmap results (cells × reads per cell power grid)</li>
<li>
<strong>3_Gene_List</strong>: Input gene list (if custom pairs provided)</li>
<li>
<strong>4_Selected_Designs</strong>: Information about drill-down selections</li>
<li>
<strong>5_Fold_Change_Power</strong>: Detailed fold change power curves</li>
<li>
<strong>6_Expression_Power</strong>: Detailed expression (TPM) power curves</li>
</ol><p>Each sheet uses logical column ordering: - <strong>Design</strong> column shows “cells × reads” format for easy identification - <strong>Cells</strong> and <strong>Reads_per_Cell</strong> as separate numeric columns for analysis - <strong>Data columns</strong> (Expression_TPM, Fold_Change, Power) follow design info - <strong>Clear naming</strong>: Descriptive column headers without redundancy</p>
</div>
</div>
<div class="section level2">
<h2 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h2>
<p>The package uses testthat (edition 3) with helper functions in <code>tests/testthat/helper-*.R</code> for test data generation. Tests compare analytical computations against simulations to ensure accuracy.</p>
</div>
<div class="section level2">
<h2 id="known-issues">Known Issues<a class="anchor" aria-label="anchor" href="#known-issues"></a></h2>
<p>Current R CMD check warnings that need attention:</p>
<ul><li>
<strong>Missing Imports</strong>: Need to declare imports for <code>Matrix</code>, <code>sceptre</code>, <code>shiny</code> packages</li>
<li>
<strong>Namespace Issues</strong>: Missing imports for standard R functions (<code>setNames</code>, <code>read.csv</code>, <code>as</code>)</li>
<li>
<strong>Hidden Files</strong>: <code>.claude</code> directory should be added to <code>.Rbuildignore</code>
</li>
</ul><p>To fix namespace issues, add to NAMESPACE:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">importFrom</span><span class="op">(</span><span class="st">"methods"</span>, <span class="st">"as"</span><span class="op">)</span></span>
<span><span class="fu">importFrom</span><span class="op">(</span><span class="st">"stats"</span>, <span class="st">"setNames"</span><span class="op">)</span></span>
<span><span class="fu">importFrom</span><span class="op">(</span><span class="st">"utils"</span>, <span class="st">"read.csv"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="parameter-naming-convention">Parameter Naming Convention<a class="anchor" aria-label="anchor" href="#parameter-naming-convention"></a></h2>
<p><strong>IMPORTANT</strong>: Use <code>TPM_threshold</code> instead of <code>TPM_threshold</code> everywhere in the package.</p>
<ul><li>All function parameters should use <code>TPM_threshold</code>
</li>
<li>All variable names should use <code>TPM_threshold</code><br></li>
<li>All documentation should reference <code>TPM_threshold</code>
</li>
<li>UI inputs should use <code>"TPM_threshold"</code> as input ID</li>
</ul><p>This ensures consistency across the entire codebase and avoids confusion between “TPM” (Transcripts Per Million) and “tmp” (temporary).</p>
</div>
<div class="section level2">
<h2 id="common-typos-to-avoid">Common Typos to Avoid<a class="anchor" aria-label="anchor" href="#common-typos-to-avoid"></a></h2>
<ul><li>
<strong><code>TPM_threshold</code> vs <code>TPM_threshold</code></strong>: Always use <code>TPM_threshold</code> (Transcripts Per Million), not <code>TPM_threshold</code> (temporary)</li>
<li>
<strong>Parameter consistency</strong>: When adding parameters to functions, double-check spelling matches existing usage</li>
<li>
<strong>Function signatures</strong>: Ensure parameter names match between function definitions and calls</li>
<li>
<strong>Careful attention to existing code</strong>: When modifying existing functions, preserve existing parameter names exactly as they are</li>
</ul></div>
<div class="section level2">
<h2 id="combined-pilot-data-upload">Combined Pilot Data Upload<a class="anchor" aria-label="anchor" href="#combined-pilot-data-upload"></a></h2>
<p>The Shiny application supports uploading combined pilot data that includes both baseline expression and library parameters in a single RDS file. This ensures consistency between these components and simplifies the upload process.</p>
<div class="section level3">
<h3 id="using-combined-pilot-data">Using Combined Pilot Data<a class="anchor" aria-label="anchor" href="#using-combined-pilot-data"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Navigate to “Experimental setup” section</strong> in the sidebar</li>
<li>
<strong>Select “Custom”</strong> for pilot data</li>
<li>
<strong>Upload an RDS file</strong> with the required combined structure (see below)</li>
<li>
<strong>Proceed with analysis</strong> - all power calculations will use your custom data</li>
</ol></div>
<div class="section level3">
<h3 id="required-rds-file-structure">Required RDS File Structure<a class="anchor" aria-label="anchor" href="#required-rds-file-structure"></a></h3>
<p>The RDS file must contain a list with exactly two named elements:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_pilot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  baseline_expression_stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    response_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ENSG00000141510"</span>, <span class="st">"ENSG00000157764"</span>, <span class="va">...</span><span class="op">)</span>,    <span class="co"># Ensembl gene IDs</span></span>
<span>    relative_expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.23e-05</span>, <span class="fl">4.56e-06</span>, <span class="va">...</span><span class="op">)</span>,             <span class="co"># TPM/1e6 scale</span></span>
<span>    expression_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">1.23</span>, <span class="va">...</span><span class="op">)</span>                          <span class="co"># Dispersion parameters</span></span>
<span>  <span class="op">)</span>,</span>
<span>  library_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    UMI_per_cell <span class="op">=</span> <span class="fl">15000</span>,    <span class="co"># Maximum UMI per cell parameter (positive numeric)</span></span>
<span>    variation <span class="op">=</span> <span class="fl">0.25</span>         <span class="co"># Variation parameter for PCR bias (positive numeric)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save as RDS file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">combined_pilot_data</span>, <span class="st">"my_combined_pilot_data.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-requirements">Data Requirements<a class="anchor" aria-label="anchor" href="#data-requirements"></a></h3>
<p><strong>baseline_expression_stats component:</strong> - <strong>baseline_expression_stats</strong>: Data frame with required columns: - <strong>response_id</strong>: Character vector of gene IDs (preferably Ensembl format: ENSGXXXXXXXXXXX) - <strong>relative_expression</strong>: Numeric vector of expression levels on TPM/1e6 scale (i.e., raw TPM divided by 1,000,000) - <strong>expression_size</strong>: Numeric vector of positive dispersion parameters - <strong>No missing values</strong> in any column - <strong>Unique gene IDs</strong> (duplicates will be removed, keeping first occurrence)</p>
<p><strong>library_parameters component:</strong> - <strong>UMI_per_cell</strong>: Maximum UMI per cell parameter from saturation curve fitting (typically 1000-50000) - <strong>variation</strong>: Variation parameter characterizing PCR amplification bias (typically 0.1-1.0) - <strong>Both parameters</strong> must be positive single numeric values - <strong>No missing values</strong> allowed</p>
</div>
<div class="section level3">
<h3 id="creating-combined-pilot-data-files">Creating Combined Pilot Data Files<a class="anchor" aria-label="anchor" href="#creating-combined-pilot-data-files"></a></h3>
<div class="section level4">
<h4 id="method-1-from-default-data">Method 1: From Default Data<a class="anchor" aria-label="anchor" href="#method-1-from-default-data"></a></h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the package and default data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://katsevich-lab.github.io/perturbplan">perturbplan</a></span><span class="op">)</span></span>
<span><span class="va">pilot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_pilot_data_from_package.html">get_pilot_data_from_package</a></span><span class="op">(</span><span class="st">"K562"</span><span class="op">)</span></span>
<span><span class="va">baseline_data</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">pilot_data</span><span class="op">$</span><span class="va">baseline_expression_stats</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pilot_data</span><span class="op">$</span><span class="va">baseline_expression_stats</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">pilot_data</span><span class="op">$</span><span class="va">baseline_expression</span><span class="op">$</span><span class="va">baseline_expression</span></span>
<span><span class="op">}</span></span>
<span><span class="va">library_data</span> <span class="op">&lt;-</span> <span class="va">pilot_data</span><span class="op">$</span><span class="va">library_parameters</span></span>
<span></span>
<span><span class="co"># Combine into the expected structure</span></span>
<span><span class="va">combined_pilot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  baseline_expression_stats <span class="op">=</span> <span class="va">baseline_data</span>,</span>
<span>  library_parameters <span class="op">=</span> <span class="va">library_data</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save as RDS</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">combined_pilot_data</span>, <span class="st">"my_combined_pilot_data.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="method-2-from-your-own-measurements">Method 2: From Your Own Measurements<a class="anchor" aria-label="anchor" href="#method-2-from-your-own-measurements"></a></h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create your own baseline expression data</span></span>
<span><span class="va">my_baseline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  response_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ENSG00000141510"</span>, <span class="st">"ENSG00000157764"</span><span class="op">)</span>,</span>
<span>  relative_expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.23e-05</span>, <span class="fl">4.56e-06</span><span class="op">)</span>,</span>
<span>  expression_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">1.23</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create your own library parameters</span></span>
<span><span class="va">my_library</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  UMI_per_cell <span class="op">=</span> <span class="fl">18000</span>,</span>
<span>  variation <span class="op">=</span> <span class="fl">0.22</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine and save</span></span>
<span><span class="va">combined_pilot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  baseline_expression_stats <span class="op">=</span> <span class="va">my_baseline</span>,</span>
<span>  library_parameters <span class="op">=</span> <span class="va">my_library</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">combined_pilot_data</span>, <span class="st">"my_custom_pilot_data.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="method-3-using-the-example-script">Method 3: Using the Example Script<a class="anchor" aria-label="anchor" href="#method-3-using-the-example-script"></a></h4>
<p>Use the example script at <code>inst/extdata/create_combined_pilot_example.R</code> for guidance on creating combined pilot data files.</p>
</div>
</div>
<div class="section level3">
<h3 id="file-validation-1">File Validation<a class="anchor" aria-label="anchor" href="#file-validation-1"></a></h3>
<p>The application automatically validates uploaded RDS files using <code><a href="reference/validate_combined_pilot_data.html">validate_combined_pilot_data()</a></code> and provides detailed error messages for: - Incorrect overall file structure or missing top-level elements - Invalid baseline expression data (delegates to <code><a href="reference/validate_custom_baseline_rds.html">validate_custom_baseline_rds()</a></code>) - Invalid library parameters (delegates to <code><a href="reference/validate_custom_library_rds.html">validate_custom_library_rds()</a></code>) - Missing values or duplicate gene IDs - File size limits (50MB maximum) - R version compatibility issues</p>
</div>
<div class="section level3">
<h3 id="integration-with-analysis-workflow">Integration with Analysis Workflow<a class="anchor" aria-label="anchor" href="#integration-with-analysis-workflow"></a></h3>
<p>Combined pilot data integrates seamlessly with all analysis features: - <strong>Compatible with both Random and Custom gene list modes</strong> - <strong>Works with all analysis parameters</strong> (test side, control group, FDR levels) - <strong>Included in Excel downloads</strong> with clear documentation of data source - <strong>Supports all visualization features</strong> (heatmaps, power curves, drill-down analysis) - <strong>Ensures consistency</strong> between baseline expression and library parameters from the same experiment</p>
</div>
<div class="section level3">
<h3 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a></h3>
<ul><li>
<strong>File size</strong>: Keep RDS files under 50MB for optimal performance</li>
<li>
<strong>Gene count</strong>: 1,000-10,000 genes typically provide good balance of comprehensiveness and speed</li>
<li>
<strong>Memory usage</strong>: Large datasets may require more RAM for analysis</li>
<li>
<strong>Parameter ranges</strong>: Extreme values may affect analysis speed or accuracy</li>
</ul></div>
<div class="section level3">
<h3 id="example-files">Example Files<a class="anchor" aria-label="anchor" href="#example-files"></a></h3>
<p>Pre-built example files are available: - <code>inst/extdata/example_combined_pilot_data.rds</code>: Combined K562 baseline and library data - <code>inst/extdata/create_combined_pilot_example.R</code>: Script for creating combined files</p>
</div>
<div class="section level3">
<h3 id="summary-display">Summary Display<a class="anchor" aria-label="anchor" href="#summary-display"></a></h3>
<p>When combined pilot data is loaded successfully, the application displays: “Loaded custom baseline expression (X,XXX genes)<br>
Average TPM: XX.X<br>
Loaded custom library parameters<br>
UMI per cell: XX,XXX<br>
Variation: X.XXXe-XX”</p>
</div>
</div>
<div class="section level2">
<h2 id="development-notes">Development Notes<a class="anchor" aria-label="anchor" href="#development-notes"></a></h2>
<ul><li>
<strong>Function Migration</strong>: <code>.compute_underspecified_power_efficient()</code> has been replaced with <code>.compute_power_plan_efficient()</code> for better performance</li>
<li>
<strong>C++ Priority</strong>: When possible, use C++ implementations over R loops for computationally intensive operations</li>
<li>
<strong>Grid Analysis</strong>: Use <code>compute_power_grid_efficient()</code> for systematic power analysis across experimental conditions</li>
<li>
<strong>ggside Faceting</strong>: When using ggplot2 faceting with ggside histograms, convert numeric faceting variables to factors explicitly to avoid “Can’t combine factor and double” errors. Use <code><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor()</a></code> with proper levels and labels before <code>facet_grid()</code>.</li>
</ul></div>
<div class="section level2">
<h2 id="git-workflow-requirements">Git Workflow Requirements<a class="anchor" aria-label="anchor" href="#git-workflow-requirements"></a></h2>
<p><strong>IMPORTANT</strong>: When commit and push is requested, the <strong>entire repository</strong> should be committed and pushed, not just specific changes.</p>
<ul><li>
<strong>Complete Sync</strong>: After commit and push, there should be <strong>no difference</strong> between the local directory and remote repository</li>
<li>
<strong>Clean Working Tree</strong>: <code>git status</code> should show a clean working tree after pushing</li>
<li>
<strong>Full Commit</strong>: Use <code>git add .</code> to stage all changes before committing, unless specifically instructed to commit only particular files</li>
<li>
<strong>Repository Consistency</strong>: The remote repository should always reflect the complete current state of the local development environment</li>
</ul><p>This ensures repository consistency and prevents issues with uncommitted changes being left behind during development sessions.</p>
</div>
<div class="section level2">
<h2 id="shiny-ui-tab-modification-guidelines">Shiny UI Tab Modification Guidelines<a class="anchor" aria-label="anchor" href="#shiny-ui-tab-modification-guidelines"></a></h2>
<p><strong>IMPORTANT</strong>: When making modifications to tabs in the Shiny UI, always ensure changes align with existing patterns:</p>
<ul><li>
<strong>Tab Header Colors</strong>: Follow the established color scheme defined in CSS selectors (e.g., <code>#exp-header</code>, <code>#perturbation-header</code>, <code>#analysis-header</code>, <code>#effects-header</code>)</li>
<li>
<strong>Collapsibility</strong>: Maintain the collapsible functionality with proper JavaScript integration</li>
<li>
<strong>CSS Consistency</strong>: Update all relevant CSS selectors and JavaScript arrays when adding/removing/modifying tabs</li>
<li>
<strong>Pattern Matching</strong>: New tabs should follow the exact same structure as existing tabs:
<ul><li>Header styling with hover effects</li>
<li>Chevron icons with proper rotation</li>
<li>Content containers with consistent padding and background</li>
<li>Display states (<code>display: none</code> for collapsed, <code>display: block</code> for expanded)</li>
</ul></li>
</ul><p>When adding or modifying tabs, check: 1. CSS selectors in <code>ui_styles.R</code> include the new tab IDs 2. JavaScript arrays (<code>allSections</code>, <code>allChevrons</code>) are updated 3. Initial state setup includes the new tab 4. Color scheme and hover effects match existing tabs</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ziang Niu, Yihui He, Eugene Katsevich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

