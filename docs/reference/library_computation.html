<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fit Saturation-Magnitude (S-M) Curve Between Reads and UMIs — library_computation • perturbplan</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit Saturation-Magnitude (S-M) Curve Between Reads and UMIs — library_computation"><meta name="description" content="Fits a nonlinear saturation curve model to estimate the relationship between mapped
reads per cell and observed UMIs per cell. The model accounts for both UMI saturation
at high read depths and PCR amplification variability. This function is used internally
by reference_data_processing."><meta property="og:description" content="Fits a nonlinear saturation curve model to estimate the relationship between mapped
reads per cell and observed UMIs per cell. The model accounts for both UMI saturation
at high read depths and PCR amplification variability. This function is used internally
by reference_data_processing."><meta property="og:image" content="https://katsevich-lab.github.io/perturbplan/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">perturbplan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/preprocess-reference.html">Prepare Data For Web App</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://katsevich-lab-perturbplan.share.connect.posit.cloud/"><span class="fa fa-external-link-alt"></span> Web App</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Katsevich-Lab/perturbplan" aria-label="GitHub repository"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fit Saturation-Magnitude (S-M) Curve Between Reads and UMIs</h1>

      <div class="d-none name"><code>library_computation.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Fits a nonlinear saturation curve model to estimate the relationship between mapped
reads per cell and observed UMIs per cell. The model accounts for both UMI saturation
at high read depths and PCR amplification variability. This function is used internally
by <code><a href="reference_data_processing.html">reference_data_processing</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">library_computation</span><span class="op">(</span><span class="va">QC_data</span>, downsample_ratio <span class="op">=</span> <span class="fl">0.7</span>, D2_rough <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-qc-data">QC_data<a class="anchor" aria-label="anchor" href="#arg-qc-data"></a></dt>
<dd><p>Data frame. UMI-level molecule information from
<code><a href="obtain_qc_read_umi_table.html">obtain_qc_read_umi_table</a></code> containing columns <code>num_reads</code>,
<code>UMI_id</code>, <code>cell_id</code>, and <code>response_id</code>.</p></dd>


<dt id="arg-downsample-ratio">downsample_ratio<a class="anchor" aria-label="anchor" href="#arg-downsample-ratio"></a></dt>
<dd><p>Numeric or numeric vector. Proportion(s) for downsampling
the dataset to create additional observation points. Must be between 0 and 1.
Can be a vector for multiple downsampling levels, but one level is often sufficient.
Default: 0.7.</p></dd>


<dt id="arg-d-rough">D2_rough<a class="anchor" aria-label="anchor" href="#arg-d-rough"></a></dt>
<dd><p>Numeric. Rough prior estimate for the variation parameter (D2) in
the S-M curve model. Represents PCR amplification bias. Typically 0.3 for perturb-seq,
higher (e.g., 0.8) for TAP-seq. Default: 0.3.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A fitted S-M curve model object of class <code>nlsLM</code> from the
<code>minpack.lm</code> package. The model has two fitted parameters accessible via
<code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code>:</p><dl><dt>total_UMIs</dt>
<dd><p>Maximum UMI count per cell at sequencing saturation</p></dd>

<dt>D2</dt>
<dd><p>Variation parameter characterizing PCR amplification bias (0 to 1)</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>

<div class="section">
<h3 id="saturation-model">Saturation Model<a class="anchor" aria-label="anchor" href="#saturation-model"></a></h3>


<p>The S-M curve model is:</p>
<p>$$\text{UMI} = \text{total_UMIs} \times \left(1 - \exp\left(-\frac{\text{reads}}{\text{total_UMIs}}\right) \times \left(1 + D2 \times \frac{\text{reads}^2}{2 \times \text{total_UMIs}^2}\right)\right)$$</p>
<p>where:</p><ul><li><p><code>reads</code>: Number of mapped reads per cell (independent variable)</p></li>
<li><p><code>UMI</code>: Number of observed UMIs per cell (dependent variable)</p></li>
<li><p><code>total_UMIs</code>: Maximum UMI per cell at saturation (fitted parameter)</p></li>
<li><p><code>D2</code>: Variation parameter for PCR bias, between 0 and 1 (fitted parameter)</p></li>
</ul></div>

<div class="section">
<h3 id="fitting-procedure">Fitting Procedure<a class="anchor" aria-label="anchor" href="#fitting-procedure"></a></h3>


<ol><li><p>Expands read data by replicating UMI indices according to read counts</p></li>
<li><p>Downsamples the read data at specified ratio(s) to create multiple observation points</p></li>
<li><p>Counts unique UMIs at each downsampled read depth</p></li>
<li><p>Fits nonlinear model using two different initial parameter sets:</p><ul><li><p>"Delicate": Uses prior D2_rough and derives initial total_UMIs</p></li>
<li><p>"Rough": Uses observed UMI count as initial total_UMIs</p></li>
</ul></li>
<li><p>Selects model with lower relative prediction error</p></li>
<li><p>Warns if relative error exceeds 5\<!-- % --></p></li>
</ol></div>

<div class="section">
<h3 id="important-notes">Important Notes<a class="anchor" aria-label="anchor" href="#important-notes"></a></h3>


<ul><li><p>The toy example data has very few reads, so fitted parameters may be sensitive
to random seed and prior specification</p></li>
<li><p>In practice with real data, the function demonstrates robustness to both random
seed choice and moderate prior misspecification</p></li>
<li><p>Multiple downsampling ratios can be provided as a vector for more observation
points, but typically one ratio suffices</p></li>
</ul></div>

    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="obtain_qc_read_umi_table.html">obtain_qc_read_umi_table</a></code> for input data preparation.</p>
<p><code><a href="reference_data_processing.html">reference_data_processing</a></code> for the complete preprocessing workflow.</p>
<p><code><a href="library_estimation.html">library_estimation</a></code> for extracting parameters from the fitted model.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Get QC data and compute library parameters</span></span></span>
<span class="r-in"><span><span class="va">cellranger_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/cellranger_tiny"</span>, package <span class="op">=</span> <span class="st">"perturbplan"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">qc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="obtain_qc_read_umi_table.html">obtain_qc_read_umi_table</a></span><span class="op">(</span><span class="va">cellranger_path</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit saturation curve</span></span></span>
<span class="r-in"><span><span class="va">lib_model</span> <span class="op">&lt;-</span> <span class="fu">library_computation</span><span class="op">(</span></span></span>
<span class="r-in"><span>  QC_data <span class="op">=</span> <span class="va">qc_data</span>,</span></span>
<span class="r-in"><span>  downsample_ratio <span class="op">=</span> <span class="fl">0.7</span>,</span></span>
<span class="r-in"><span>  D2_rough <span class="op">=</span> <span class="fl">0.3</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View fitted parameters</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lib_model</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> total_UMIs         D2 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   7.611741   1.000000 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extract specific parameters</span></span></span>
<span class="r-in"><span><span class="va">total_umis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lib_model</span><span class="op">)</span><span class="op">[</span><span class="st">"total_UMIs"</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">variation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lib_model</span><span class="op">)</span><span class="op">[</span><span class="st">"D2"</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ziang Niu, Yihui He, Eugene Katsevich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

