<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="perturbplan">
<title>Preprocess Reference Expression data for Web App • perturbplan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Preprocess Reference Expression data for Web App">
<meta property="og:description" content="perturbplan">
<meta property="og:image" content="https://katsevich-lab.github.io/perturbplan/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">perturbplan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/preprocess-reference.html">Prepare Data For Web App</a>
    <a class="dropdown-item" href="../articles/prospective-power.html">Prospective Power Analysis</a>
    <a class="dropdown-item" href="../articles/posthoc.html">Retrospective Power Analysis</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://katsevich-lab-perturbplan.share.connect.posit.cloud/">
    <span class="fa fa-external-link-alt"></span>
     
    Web App
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Katsevich-Lab/perturbplan" aria-label="GitHub repository">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Preprocess Reference Expression data for Web App</h1>
            
      
      
      <div class="d-none name"><code>preprocess-reference.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates how to preprocess your own perturb-seq
pilot data for use with the PerturbPlan web application and power
analysis functions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://katsevich-lab.github.io/perturbplan">perturbplan</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>PerturbPlan requires three types of information from pilot data for
power analysis:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Baseline Expression Statistics</strong>: Gene-level
expression parameters (mean and dispersion) fitted from a negative
binomial model</li>
<li>
<strong>Library Parameters</strong>: Read-to-UMI saturation curve
parameters (UMI_per_cell and variation) that characterize library
preparation and PCR amplification bias</li>
<li>
<strong>Mapping Efficiency</strong>: Proportion of reads that map to
the transcriptome we’re interested in</li>
</ol>
<p>This preprocessing workflow consists of two main steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong><code><a href="../reference/reference_data_preprocessing_10x.html">reference_data_preprocessing_10x()</a></code></strong>:
Load raw data from multiple SRR runs of raw Cell Ranger outputs and
aggregate them into a list containing:
<ul>
<li>Gene-by-cell expression matrix</li>
<li>UMI-level molecule information dataframe</li>
<li>Naive estimate of mapping efficiency (proportion of reads mapped to
the whole transcriptome among all reads)</li>
</ul>
</li>
<li>
<strong><code><a href="../reference/reference_data_processing.html">reference_data_processing()</a></code></strong>: Fits
statistical models with the aggregated data from Step 1 to extract
parameters needed for power analysis</li>
</ol>
</div>
<div class="section level2">
<h2 id="step-1-aggregate-cell-ranger-outputs">Step 1: Aggregate Cell Ranger Outputs<a class="anchor" aria-label="anchor" href="#step-1-aggregate-cell-ranger-outputs"></a>
</h2>
<p>The <code>reference_data_preprocessing_10x</code> function aggregates
Cell Ranger outputs from multiple sequencing runs (SRRs) into a single
data structure.</p>
<div class="section level3">
<h3 id="input-requirements">Input Requirements<a class="anchor" aria-label="anchor" href="#input-requirements"></a>
</h3>
<p>Your data should be organized with Cell Ranger output directories
under a top-level folder:</p>
<pre><code>path_to_top_level_output/
├── SRR_run_1/
│   ├── outs/
│   │   ├── filtered_feature_bc_matrix/
│   │   │   ├── barcodes.tsv.gz
│   │   │   ├── features.tsv.gz
│   │   │   └── matrix.mtx.gz
│   │   ├── molecule_info.h5
│   │   ├── filtered_feature_bc_matrix.h5
│   │   └── metrics_summary.csv
├── SRR_run_2/
│   └── ...
└── SRR_run_3/
    └── ...</code></pre>
<p>Your SRR directories should be generated by a recent version of Cell
Ranger configured for the perturbation (CRISPR or Perturb-seq) workflow.
In some cases, the subfolder <code>filtered_feature_bc_matrix</code> may
need to be produced by unzipping the
<code>filtered_feature_bc_matrix.tar.gz</code> file. In addition, each
metrics_summary.csv file must include a column named Number of Reads,
which is required to estimate mapping efficiency. This column may need
to be added or edited manually when Cell Ranger is run with multiple
libraries or multiple samples.</p>
<p>For more information about input format and required fields, see
<code><a href="../reference/obtain_qc_response_data.html">?obtain_qc_response_data</a></code>,
<code><a href="../reference/obtain_qc_read_umi_table.html">?obtain_qc_read_umi_table</a></code>, and
<code><a href="../reference/obtain_mapping_efficiency.html">?obtain_mapping_efficiency</a></code>.</p>
</div>
<div class="section level3">
<h3 id="function-usage">Function Usage<a class="anchor" aria-label="anchor" href="#function-usage"></a>
</h3>
<p>There’s an example SRR folder called <code>cellranger_tiny</code>
under thefolder <code>extdata</code> in our package, and we’ll use that
for demonstration:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Point to directory containing example Cell Ranger outputs</span></span>
<span><span class="va">extdata_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"perturbplan"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Aggregate data from all SRR runs</span></span>
<span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reference_data_preprocessing_10x.html">reference_data_preprocessing_10x</a></span><span class="op">(</span></span>
<span>  path_to_top_level_output <span class="op">=</span> <span class="va">extdata_path</span>,</span>
<span>  path_to_run_level_output <span class="op">=</span> <span class="st">"cellranger_tiny"</span>,  <span class="co"># Only read subfolder cellranger_tiny </span></span>
<span>  h5_rough <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># Use first SRR for QC data (faster)</span></span>
<span>  skip_mapping_efficiency <span class="op">=</span> <span class="cn">FALSE</span>  <span class="co"># Estimate mapping efficiency</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Arguments:</strong></p>
<ul>
<li>
<code>path_to_top_level_output</code>: Path to directory containing
Cell Ranger run-level subdirectories</li>
<li>
<code>path_to_run_level_output</code>: Optional character vector
specifying subset of run directories to process</li>
<li>
<code>h5_rough</code>: If <code>TRUE</code> (default), extracts the
UMI-level molecule information dataframe from first SRR only for speed.
If <code>FALSE</code>, combines UMI-level molecule information from all
SRRs</li>
<li>
<code>skip_mapping_efficiency</code>: If <code>TRUE</code>, skips
estimation of mapping efficiency. If <code>FALSE</code> (default),
calculates naive mapping efficiency using data from a properly formatted
<code>metrics_summary.csv</code> file as described above.</li>
</ul>
</div>
<div class="section level3">
<h3 id="function-output">Function Output<a class="anchor" aria-label="anchor" href="#function-output"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">raw_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ response_matrix   :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span></span>
<span><span class="co">#&gt;   .. ..@ i       : int [1:11] 0 1 2 3 4 1 2 1 4 1 ...</span></span>
<span><span class="co">#&gt;   .. ..@ p       : int [1:9] 0 1 2 3 4 5 7 9 11</span></span>
<span><span class="co">#&gt;   .. ..@ Dim     : int [1:2] 5 8</span></span>
<span><span class="co">#&gt;   .. ..@ Dimnames:List of 2</span></span>
<span><span class="co">#&gt;   .. .. ..$ : chr [1:5] "ENSG00000243485" "ENSG00000238009" "ENSG00000239945" "ENSG00000241860" ...</span></span>
<span><span class="co">#&gt;   .. .. ..$ : chr [1:8] "AGCAGCCGTCCAAGTT-1" "AAACGGGTCAGCTCGG-1" "AAAGTAGCATCCCACT-1" "AAACCTGGTATATGAG-1" ...</span></span>
<span><span class="co">#&gt;   .. ..@ x       : num [1:11] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   .. ..@ factors : list()</span></span>
<span><span class="co">#&gt;  $ read_umi_table    :'data.frame':  11 obs. of  5 variables:</span></span>
<span><span class="co">#&gt;   ..$ num_reads  : int [1:11] 2 1 1 2 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ UMI_id     : num [1:11] 139105 723247 998389 622094 584568 ...</span></span>
<span><span class="co">#&gt;   ..$ cell_id    : chr [1:11] "AAACCTGGTATATGAG-1" "AAACGGGTCAGCTCGG-1" "AAAGTAGCATCCCACT-1" "AAAGTAGTCCAAATGC-1" ...</span></span>
<span><span class="co">#&gt;   ..$ response_id: chr [1:11] "ENSG00000241860" "ENSG00000238009" "ENSG00000239945" "ENSG00000286448" ...</span></span>
<span><span class="co">#&gt;   ..$ srr_idx    : chr [1:11] "cellranger_tiny" "cellranger_tiny" "cellranger_tiny" "cellranger_tiny" ...</span></span>
<span><span class="co">#&gt;  $ mapping_efficiency: num 1</span></span></code></pre></div>
<p><strong>Format of each output:</strong></p>
<ul>
<li>
<code>response_matrix</code>: a sparse gene-by-cell expression
matrix (genes as rows, cells as columns) with row and column names</li>
<li>
<code>read_umi_table</code>: a data frame with UMI-level molecule
information, including columns:
<ul>
<li>
<code>num_reads</code>: Number of reads supporting this UMI-cell
combination</li>
<li>
<code>UMI_id</code>: UMI index of this UMI-cell combination</li>
<li>
<code>cell_id</code>: Cell barcode of this UMI-cell combination</li>
<li>
<code>response_id</code>: Gene identifier (e.g., Ensembl ID)</li>
<li>
<code>srr_idx</code>: SRR run identifier of the UMI</li>
</ul>
</li>
<li>
<code>mapping_efficiency</code>: A numeric value between 0 and 1 if
<code>skip_mapping_efficiency = FALSE</code>, and NULL if
<code>skip_mapping_efficiency = TRUE</code>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="step-2-extract-statistical-parameters">Step 2: Extract Statistical Parameters<a class="anchor" aria-label="anchor" href="#step-2-extract-statistical-parameters"></a>
</h2>
<p>The <code>reference_data_processing</code> function fits statistical
models to extract gene-level expression parameters, library parameters
and more sophisticated mapping efficiency required by PerturbPlan.</p>
<div class="section level3">
<h3 id="statistical-models">Statistical Models<a class="anchor" aria-label="anchor" href="#statistical-models"></a>
</h3>
<div class="section level4">
<h4 id="gene-expression-model-negative-binomial">Gene Expression Model (Negative Binomial)<a class="anchor" aria-label="anchor" href="#gene-expression-model-negative-binomial"></a>
</h4>
<p>For each gene, the function fits a negative binomial (NB) model to
characterize the distribution of gene expression levels across
cells:</p>
<p><span class="math display">\[\text{gene_expression} \sim
\text{NB}(\text{mean} = \text{library_size} \times
\text{relative_expression}, \text{size} =
\text{expression_size})\]</span></p>
<p>where</p>
<ul>
<li>
<code>gene_expression</code>: Number of observed UMIs for the gene
in each cell</li>
<li>
<code>library_size</code>: Total UMI count per cell</li>
</ul>
<p>are the data to use, and</p>
<ul>
<li>
<code>relative_expression</code>: Relative expression level of the
gene (fitted parameter)</li>
<li>
<code>expression_size</code>: Dispersion parameter (small values
indicate high biological variability)</li>
</ul>
<p>are the fitted parameters.</p>
</div>
<div class="section level4">
<h4 id="sequencing-saturation-model-s-m-curve">Sequencing Saturation Model (S-M Curve)<a class="anchor" aria-label="anchor" href="#sequencing-saturation-model-s-m-curve"></a>
</h4>
<p>The function fits a saturation (S-M) curve that relates mapped reads
per cell to observed UMIs per cell:</p>
<p><span class="math display">\[\text{UMI} = \text{total_UMIs} \times
\left(1 - \exp\left(-\frac{\text{reads}}{\text{total_UMIs}}\right)
\times \left(1 + \text{variation} \times \frac{\text{reads}^2}{2 \times
\text{total_UMIs}^2}\right)\right)\]</span></p>
<p>where</p>
<ul>
<li>
<code>reads</code>: Number of mapped reads per cell</li>
<li>
<code>UMI</code>: Number of observed UMIs per cell</li>
</ul>
<p>are the data to use, and</p>
<ul>
<li>
<code>total_UMIs</code> (UMI_per_cell): Maximum UMI per cell
parameter at sequencing saturation</li>
<li>
<code>variation</code>: Variation parameter characterizing PCR
amplification bias (between 0 and 1)</li>
</ul>
<p>are the fitted parameters.</p>
</div>
</div>
<div class="section level3">
<h3 id="function-usage-1">Function Usage<a class="anchor" aria-label="anchor" href="#function-usage-1"></a>
</h3>
<p>Here, we demonstrate two use cases of
<code>reference_data_processing</code> with the aggregated data from
Step 1, one for perturb-seq experimental design using all genes, and one
for TAP-seq experimental design using a targeted gene list. The toy
examples have too few reads, so the fitted parameters may be sensitive
to the random seed and the prior variation parameter. In practice, our
function demonstrates robustness to both the choice of random seed and
moderate misspecification of the prior for the variation parameter.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Process into final pilot data format with all genes, suitable for perturb-seq experimental design</span></span>
<span><span class="va">pilot_data_perturbseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reference_data_processing.html">reference_data_processing</a></span><span class="op">(</span></span>
<span>  response_matrix <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>  read_umi_table <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">read_umi_table</span>,</span>
<span>  mapping_efficiency <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">mapping_efficiency</span>,</span>
<span>  gene_list <span class="op">=</span> <span class="cn">NULL</span>,     <span class="co"># Use all genes</span></span>
<span>  TPM_thres <span class="op">=</span> <span class="fl">0.1</span>,      <span class="co"># Default expression threshold for filtering</span></span>
<span>  downsample_ratio <span class="op">=</span> <span class="fl">0.6</span>,  <span class="co"># Downsampling for sequencing</span></span>
<span>  D2_rough <span class="op">=</span> <span class="fl">0.4</span>,       <span class="co"># prior for variation parameter</span></span>
<span>  h5_only <span class="op">=</span> <span class="cn">FALSE</span>,      <span class="co"># Set TRUE to skip expression model fitting</span></span>
<span>  n_threads <span class="op">=</span> <span class="cn">NULL</span>      <span class="co"># No parallel processing</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting pilot data preprocessing @ 2025-10-10 13:55:41.928526</span></span>
<span><span class="co">#&gt; Step 1: Computing gene expression information...</span></span>
<span><span class="co">#&gt; Start relative expression calculation @ 2025-10-10 13:55:41.954078</span></span>
<span><span class="co">#&gt; Finish relative expression calculation @ 2025-10-10 13:55:41.956274</span></span>
<span><span class="co">#&gt; Number of genes passing TPM threshold: 5</span></span>
<span><span class="co">#&gt; Start dispersion estimation (8 thread(s)) @ 2025-10-10 13:55:41.957164</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Starting computation</span></span>
<span><span class="co">#&gt;  - G (genes) = 5</span></span>
<span><span class="co">#&gt;  - C (cells) = 8</span></span>
<span><span class="co">#&gt; [gene 0] rel_expr = 0.0909091</span></span>
<span><span class="co">#&gt; [gene 0] t_0 = 0.0747664</span></span>
<span><span class="co">#&gt; [gene 0] theta_mle_row result = 401.014</span></span>
<span><span class="co">#&gt; [gene 1] rel_expr = 0.363636</span></span>
<span><span class="co">#&gt; [gene 1] t_0 = 1.06889</span></span>
<span><span class="co">#&gt; [gene 1] theta_mle_row result = 484.176</span></span>
<span><span class="co">#&gt; [gene 2] rel_expr = 0.181818</span></span>
<span><span class="co">#&gt; [gene 2] t_0 = 0.272921</span></span>
<span><span class="co">#&gt; [gene 2] theta_mle_row result = 468.498</span></span>
<span><span class="co">#&gt; [gene 3] rel_expr = 0.181818</span></span>
<span><span class="co">#&gt; [gene 3] t_0 = 0.272921</span></span>
<span><span class="co">#&gt; [gene 3] theta_mle_row result = 468.498</span></span>
<span><span class="co">#&gt; [gene 4] rel_expr = 0.181818</span></span>
<span><span class="co">#&gt; [gene 4] t_0 = 0.272921</span></span>
<span><span class="co">#&gt; [gene 4] theta_mle_row result = 468.498</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Done.</span></span>
<span><span class="co">#&gt; Finish dispersion estimation @ 2025-10-10 13:55:41.961251</span></span>
<span><span class="co">#&gt; Step 2: Estimating library parameters...</span></span>
<span><span class="co">#&gt; Completed pilot data preprocessing @ 2025-10-10 13:55:41.977841</span></span>
<span><span class="co">#&gt; Processed 5 genes</span></span>
<span><span class="co">#&gt; Library parameters: UMI_per_cell = 6, variation = 0.371</span></span>
<span><span class="co">#&gt; Mapping efficiency = 1</span></span>
<span></span>
<span><span class="co"># Process into pilot data format with targetd genes only, suitable for TAP-seq experimental design</span></span>
<span><span class="va">gene_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ENSG00000241860"</span>, <span class="st">"ENSG00000238009"</span>, <span class="st">"ENSG00000239945"</span><span class="op">)</span></span>
<span><span class="va">pilot_data_tapseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reference_data_processing.html">reference_data_processing</a></span><span class="op">(</span></span>
<span>  response_matrix <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>  read_umi_table <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">read_umi_table</span>,</span>
<span>  mapping_efficiency <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">mapping_efficiency</span>,</span>
<span>  gene_list <span class="op">=</span> <span class="va">gene_list</span>, <span class="co"># Restrict to specific genes</span></span>
<span>  TPM_thres <span class="op">=</span> <span class="fl">0</span>          <span class="co"># No expression threshold for filtering</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting pilot data preprocessing @ 2025-10-10 13:55:41.981353</span></span>
<span><span class="co">#&gt; Step 1: Computing gene expression information...</span></span>
<span><span class="co">#&gt; Start relative expression calculation @ 2025-10-10 13:55:41.995723</span></span>
<span><span class="co">#&gt; Finish relative expression calculation @ 2025-10-10 13:55:41.996553</span></span>
<span><span class="co">#&gt; Number of genes passing TPM threshold: 3</span></span>
<span><span class="co">#&gt; Start dispersion estimation (8 thread(s)) @ 2025-10-10 13:55:41.997494</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Starting computation</span></span>
<span><span class="co">#&gt;  - G (genes) = 3</span></span>
<span><span class="co">#&gt;  - C (cells) = 8</span></span>
<span><span class="co">#&gt; [gene 0] rel_expr = 0.5</span></span>
<span><span class="co">#&gt; [gene 0] t_0 = 1.33333</span></span>
<span><span class="co">#&gt; [gene 0] theta_mle_row result = 486.513</span></span>
<span><span class="co">#&gt; [gene 1] rel_expr = 0.25</span></span>
<span><span class="co">#&gt; [gene 1] t_0 = 0.5</span></span>
<span><span class="co">#&gt; [gene 1] theta_mle_row result = 475.754</span></span>
<span><span class="co">#&gt; [gene 2] rel_expr = 0.25</span></span>
<span><span class="co">#&gt; [gene 2] t_0 = 0.5</span></span>
<span><span class="co">#&gt; [gene 2] theta_mle_row result = 475.754</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Done.</span></span>
<span><span class="co">#&gt; Finish dispersion estimation @ 2025-10-10 13:55:41.999453</span></span>
<span><span class="co">#&gt; Step 2: Estimating library parameters...</span></span>
<span><span class="co">#&gt; Completed pilot data preprocessing @ 2025-10-10 13:55:42.011565</span></span>
<span><span class="co">#&gt; Processed 3 genes</span></span>
<span><span class="co">#&gt; Library parameters: UMI_per_cell = 7, variation = 0.366</span></span>
<span><span class="co">#&gt; Mapping efficiency = 0.727</span></span></code></pre></div>
<p><strong>Arguments:</strong></p>
<ul>
<li>
<code>response_matrix</code>: Gene-by-cell expression matrix from
Step 1 (or NULL if <code>h5_only = TRUE</code>)</li>
<li>
<code>read_umi_table</code>: QC data frame from Step 1</li>
<li>
<code>mapping_efficiency</code>: Mapping efficiency from Step 1</li>
<li>
<code>gene_list</code>: Optional character vector to restrict
analysis to specific genes</li>
<li>
<code>TPM_thres</code>: Threshold for filtering low-expression genes
in gene expression model (default: 0.1)</li>
<li>
<code>downsample_ratio</code>: Proportion of downsampling in library
saturation model fitting (default: 0.7)</li>
<li>
<code>D2_rough</code>: Rough prior value for library variation
parameter, it’s typically higher in TAP seq experiment (i.e. 0.8)
(default for perturbseq experiment: 0.3)</li>
<li>
<code>h5_only</code>: If <code>TRUE</code>, skips baseline
expression step to save time, useful when you’re trying to find sensible
hyperparameters for library model fitting (default: FALSE)</li>
<li>
<code>n_threads</code>: Number of parallel processing threads
(default: NULL for single-threaded)</li>
</ul>
</div>
<div class="section level3">
<h3 id="function-output-1">Function Output<a class="anchor" aria-label="anchor" href="#function-output-1"></a>
</h3>
<p>As for the output of <code>reference_data_processing</code>, the
relative expression is higher and the mapping efficiency is lower in the
TAP-seq example due to the change in normalization. The library
parameters are similar between the two toy examples, but it’s often not
the case in reality. If we use a real TAP-seq dataset, the variation
parameter in library_parameters would typically be higher (closer to 1)
than that in perturb-seq (around 0.3).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect structure of perturb-seq pilot data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pilot_data_perturbseq</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ baseline_expression_stats:'data.frame':   5 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ response_id        : chr [1:5] "ENSG00000243485" "ENSG00000238009" "ENSG00000239945" "ENSG00000241860" ...</span></span>
<span><span class="co">#&gt;   ..$ relative_expression: num [1:5] 0.0909 0.3636 0.1818 0.1818 0.1818</span></span>
<span><span class="co">#&gt;   ..$ expression_size    : num [1:5] 401 484 468 468 468</span></span>
<span><span class="co">#&gt;  $ library_parameters       :List of 2</span></span>
<span><span class="co">#&gt;   ..$ UMI_per_cell: num 6.12</span></span>
<span><span class="co">#&gt;   ..$ variation   : num 0.371</span></span>
<span><span class="co">#&gt;  $ mapping_efficiency       : num 1</span></span>
<span></span>
<span><span class="co"># Inspect structure of TAP-seq pilot data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pilot_data_tapseq</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ baseline_expression_stats:'data.frame':   3 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ response_id        : chr [1:3] "ENSG00000238009" "ENSG00000239945" "ENSG00000241860"</span></span>
<span><span class="co">#&gt;   ..$ relative_expression: num [1:3] 0.5 0.25 0.25</span></span>
<span><span class="co">#&gt;   ..$ expression_size    : num [1:3] 487 476 476</span></span>
<span><span class="co">#&gt;  $ library_parameters       :List of 2</span></span>
<span><span class="co">#&gt;   ..$ UMI_per_cell: num 6.82</span></span>
<span><span class="co">#&gt;   ..$ variation   : num 0.366</span></span>
<span><span class="co">#&gt;  $ mapping_efficiency       : num 0.727</span></span></code></pre></div>
<p><strong>Format of each output:</strong></p>
<ul>
<li>
<code>baseline_expression_stats</code>: Data frame with columns:
<ul>
<li>
<code>response_id</code>: Ensembl gene identifier</li>
<li>
<code>relative_expression</code>: Estimated relative expression
proportions for each gene, normalized to sum to 1 across all genes of
interest</li>
<li>
<code>expression_size</code>: Estimated dispersion (size) parameter
representing gene-specific expression variability</li>
</ul>
</li>
<li>
<code>library_parameters</code>: List with:
<ul>
<li>
<code>UMI_per_cell</code>: Estimated maximum UMI count per cell</li>
<li>
<code>variation</code>: Estimated PCR amplification variation
parameter</li>
</ul>
</li>
<li>
<code>mapping_efficiency</code>: Adjusted mapping efficiency,
accounting for the fraction of reads mapped to the genes of
interest</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="see-also">See Also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<ul>
<li>
<code><a href="../reference/reference_data_preprocessing_10x.html">?reference_data_preprocessing_10x</a></code>: Formal documentation
of <code>reference_data_preprocessing_10x</code>
</li>
<li>
<code><a href="../reference/reference_data_processing.html">?reference_data_processing</a></code>: Formal documentation of
<code>reference_data_processing</code>
</li>
<li>
<code><a href="../reference/obtain_qc_response_data.html">?obtain_qc_response_data</a></code>,
<code><a href="../reference/obtain_qc_read_umi_table.html">?obtain_qc_read_umi_table</a></code>, and
<code><a href="../reference/obtain_mapping_efficiency.html">?obtain_mapping_efficiency</a></code>: Documentation on obtaining each
component of the output in
<code>reference_data_preprocessing_10x</code>.</li>
<li>
<code><a href="../reference/obtain_expression_information.html">?obtain_expression_information</a></code>: Documentation on
fitting the negative binomial model in
<code>reference_data_processing</code>.</li>
<li>
<code><a href="../reference/library_computation.html">?library_computation</a></code>: Documentation on fitting the
sequencing saturation model in
<code>reference_data_processing</code>.</li>
<li>Vignette “Getting Started with PerturbPlan”: Overview of power
analysis workflow</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ziang Niu, Yihui He, Eugene Katsevich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
