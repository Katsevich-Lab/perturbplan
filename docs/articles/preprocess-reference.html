<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Preprocess Reference Expression data for Web App • perturbplan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Preprocess Reference Expression data for Web App">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">perturbplan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/preprocess-reference.html">Prepare Data For Web App</a></li>
    <li><a class="dropdown-item" href="../articles/prospective-power.html">Prospective Power Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/posthoc.html">Retrospective Power Analysis</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://katsevich-lab-perturbplan.share.connect.posit.cloud/"><span class="fa fa-external-link-alt"></span> Web App</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Katsevich-Lab/perturbplan" aria-label="GitHub repository"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Preprocess Reference Expression data for Web App</h1>
            
      

      <div class="d-none name"><code>preprocess-reference.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates how to preprocess your own perturb-seq
pilot data for use with the PerturbPlan web application and power
analysis functions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://katsevich-lab.github.io/perturbplan">perturbplan</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This preprocessing workflow consists of two main steps:</p>
<ol style="list-style-type: decimal">
<li>
<p><strong><code><a href="../reference/reference_data_preprocessing_10x.html">reference_data_preprocessing_10x()</a></code></strong>:
Loading raw data from multiple SRR runs of raw Cell Ranger outputs and
processing them into a list containing:</p>
<ul>
<li>Gene-by-cell expression matrix</li>
<li>UMI-level molecule information dataframe</li>
<li>Proportion of reads confidently mapped to the whole transcriptome
among all reads</li>
</ul>
</li>
<li>
<p><strong><code><a href="../reference/reference_data_processing.html">reference_data_processing()</a></code></strong>:
Fitting statistical models with the output from Step 1 and obtaining
parameters needed for power analysis. These parameters include:</p>
<ul>
<li>
<strong>Baseline expression statistics</strong>: Baseline gene
expression parameters: <code>response_id</code>,
<code>relative_expression</code> and <code>expression_size</code>
</li>
<li>
<strong>Library parameters</strong>: Reads-UMIs saturation curve
parameters: <code>UMI_per_cell</code> and <code>variation</code>. These
two parameters characterize library size and PCR amplification bias,
given the cell type and assay of interest</li>
<li>
<strong>Mapping efficiency</strong>: Proportion of reads that are
confidently mapped to the transcripts of genes we’re interested in.</li>
</ul>
</li>
</ol>
<p>The output after the two-step preprocessing can be uploaded to the
Web App as custom reference data.</p>
</div>
<div class="section level2">
<h2 id="step-1-process-cell-ranger-outputs">Step 1: Process Cell Ranger Outputs<a class="anchor" aria-label="anchor" href="#step-1-process-cell-ranger-outputs"></a>
</h2>
<p>The <code>reference_data_preprocessing_10x</code> function aggregates
Cell Ranger outputs from multiple sequencing runs (SRRs) into a single
data structure.</p>
<div class="section level3">
<h3 id="input-requirements">Input Requirements<a class="anchor" aria-label="anchor" href="#input-requirements"></a>
</h3>
<p>Your data should be organized with Cell Ranger output directories
under a top-level folder:</p>
<pre><code>path_to_top_level_output/
├── SRR_run_1/
│   ├── outs/
│   │   ├── filtered_feature_bc_matrix/
│   │   │   ├── barcodes.tsv.gz
│   │   │   ├── features.tsv.gz
│   │   │   └── matrix.mtx.gz
│   │   ├── molecule_info.h5
│   │   ├── filtered_feature_bc_matrix.h5
│   │   └── metrics_summary.csv
├── SRR_run_2/
│   └── ...
└── SRR_run_3/
    └── ...</code></pre>
<p>Your SRR directories should be generated by a recent version of Cell
Ranger configured for the perturbation (CRISPR or Perturb-seq) workflow.
In some cases, the subfolder <code>filtered_feature_bc_matrix</code> may
need to be produced by unzipping the
<code>filtered_feature_bc_matrix.tar.gz</code> file. In addition, each
metrics_summary.csv file must include a column named Number of Reads,
which is required to estimate mapping efficiency. This column may need
to be added or edited manually when Cell Ranger is run with multiple
libraries or multiple samples.</p>
<p>For more information about input format and required fields, see
<code><a href="../reference/obtain_qc_response_data.html">?obtain_qc_response_data</a></code>,
<code><a href="../reference/obtain_qc_read_umi_table.html">?obtain_qc_read_umi_table</a></code>, and
<code><a href="../reference/obtain_mapping_efficiency.html">?obtain_mapping_efficiency</a></code>.</p>
</div>
<div class="section level3">
<h3 id="function-usage">Function Usage<a class="anchor" aria-label="anchor" href="#function-usage"></a>
</h3>
<p>There’s an example SRR folder called <code>cellranger_tiny</code>
under the folder <code>extdata</code> in our package, and we’ll use that
for demonstration:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Point to directory containing example Cell Ranger outputs</span></span>
<span><span class="va">extdata_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"perturbplan"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Aggregate data from all SRR runs</span></span>
<span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reference_data_preprocessing_10x.html">reference_data_preprocessing_10x</a></span><span class="op">(</span></span>
<span>  path_to_top_level_output <span class="op">=</span> <span class="va">extdata_path</span>,</span>
<span>  path_to_run_level_output <span class="op">=</span> <span class="st">"cellranger_tiny"</span>,  <span class="co"># Only read subfolder cellranger_tiny </span></span>
<span>  h5_rough <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># Use first SRR for QC data (faster)</span></span>
<span>  skip_mapping_efficiency <span class="op">=</span> <span class="cn">FALSE</span>  <span class="co"># Estimate mapping efficiency</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Arguments:</strong></p>
<ul>
<li>
<code>path_to_top_level_output</code>: Path to directory containing
Cell Ranger run-level subdirectories</li>
<li>
<code>path_to_run_level_output</code>: Optional character vector
specifying subset of run directories to process</li>
<li>
<code>h5_rough</code>: If <code>TRUE</code> (default), extracts the
UMI-level molecule information dataframe from first SRR only for speed.
If <code>FALSE</code>, combines UMI-level molecule information from all
SRRs</li>
<li>
<code>skip_mapping_efficiency</code>: If <code>TRUE</code>, skips
estimation of mapping efficiency. If <code>FALSE</code> (default),
calculates naive mapping efficiency using data from a properly formatted
<code>metrics_summary.csv</code> file as described above.</li>
</ul>
</div>
<div class="section level3">
<h3 id="function-output">Function Output<a class="anchor" aria-label="anchor" href="#function-output"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">raw_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ response_matrix   :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span></span>
<span><span class="co">#&gt;   .. ..@ i       : int [1:11] 0 1 2 3 4 1 2 1 4 1 ...</span></span>
<span><span class="co">#&gt;   .. ..@ p       : int [1:9] 0 1 2 3 4 5 7 9 11</span></span>
<span><span class="co">#&gt;   .. ..@ Dim     : int [1:2] 5 8</span></span>
<span><span class="co">#&gt;   .. ..@ Dimnames:List of 2</span></span>
<span><span class="co">#&gt;   .. .. ..$ : chr [1:5] "ENSG00000243485" "ENSG00000238009" "ENSG00000239945" "ENSG00000241860" ...</span></span>
<span><span class="co">#&gt;   .. .. ..$ : chr [1:8] "AGCAGCCGTCCAAGTT-1" "AAACGGGTCAGCTCGG-1" "AAAGTAGCATCCCACT-1" "AAACCTGGTATATGAG-1" ...</span></span>
<span><span class="co">#&gt;   .. ..@ x       : num [1:11] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   .. ..@ factors : list()</span></span>
<span><span class="co">#&gt;  $ read_umi_table    :'data.frame':  11 obs. of  5 variables:</span></span>
<span><span class="co">#&gt;   ..$ num_reads  : int [1:11] 2 1 1 2 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ UMI_id     : num [1:11] 139105 723247 998389 622094 584568 ...</span></span>
<span><span class="co">#&gt;   ..$ cell_id    : chr [1:11] "AAACCTGGTATATGAG-1" "AAACGGGTCAGCTCGG-1" "AAAGTAGCATCCCACT-1" "AAAGTAGTCCAAATGC-1" ...</span></span>
<span><span class="co">#&gt;   ..$ response_id: chr [1:11] "ENSG00000241860" "ENSG00000238009" "ENSG00000239945" "ENSG00000286448" ...</span></span>
<span><span class="co">#&gt;   ..$ srr_idx    : chr [1:11] "cellranger_tiny" "cellranger_tiny" "cellranger_tiny" "cellranger_tiny" ...</span></span>
<span><span class="co">#&gt;  $ mapping_efficiency: num 1</span></span></code></pre></div>
<p><strong>Format of each output:</strong></p>
<ul>
<li>
<code>response_matrix</code>: a sparse gene-by-cell expression
matrix (genes as rows, cells as columns) with row and column names</li>
<li>
<code>read_umi_table</code>: a data frame with UMI-level molecule
information, including columns:
<ul>
<li>
<code>num_reads</code>: Number of reads supporting this UMI-cell
combination</li>
<li>
<code>UMI_id</code>: UMI index of this UMI-cell combination</li>
<li>
<code>cell_id</code>: Cell barcode of this UMI-cell combination</li>
<li>
<code>response_id</code>: Gene identifier (e.g., Ensembl ID)</li>
<li>
<code>srr_idx</code>: SRR run identifier of the UMI</li>
</ul>
</li>
<li>
<code>mapping_efficiency</code>: A numeric value between 0 and 1 if
<code>skip_mapping_efficiency = FALSE</code>, and NULL if
<code>skip_mapping_efficiency = TRUE</code>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="step-2-extract-statistical-parameters">Step 2: Extract Statistical Parameters<a class="anchor" aria-label="anchor" href="#step-2-extract-statistical-parameters"></a>
</h2>
<p>The <code>reference_data_processing</code> function fits statistical
models to extract gene expression parameters, library parameters and
more sophisticated mapping efficiency required by PerturbPlan. We
postpone the details of these two models to the end of this
document.</p>
<div class="section level3">
<h3 id="function-usage-1">Function Usage<a class="anchor" aria-label="anchor" href="#function-usage-1"></a>
</h3>
<p>We demonstrate two use cases of
<code>reference_data_processing</code> with the aggregated data from
Step 1 (<code>raw_data</code>): one for perturb-seq experimental design
using all genes, and one for TAP-seq experimental design using a
targeted gene list.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Process into final pilot data format with all genes, suitable for perturb-seq experimental design</span></span>
<span><span class="va">pilot_data_perturbseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reference_data_processing.html">reference_data_processing</a></span><span class="op">(</span></span>
<span>  response_matrix <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>  read_umi_table <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">read_umi_table</span>,</span>
<span>  mapping_efficiency <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">mapping_efficiency</span>,</span>
<span>  gene_list <span class="op">=</span> <span class="cn">NULL</span>,     <span class="co"># Use all genes</span></span>
<span>  TPM_thres <span class="op">=</span> <span class="fl">0.1</span>,      <span class="co"># Default expression threshold for filtering</span></span>
<span>  downsample_ratio <span class="op">=</span> <span class="fl">0.6</span>,  <span class="co"># Downsampling for sequencing</span></span>
<span>  D2_rough <span class="op">=</span> <span class="fl">0.4</span>,       <span class="co"># prior for variation parameter</span></span>
<span>  h5_only <span class="op">=</span> <span class="cn">FALSE</span>,      <span class="co"># Set TRUE to skip expression model fitting</span></span>
<span>  n_threads <span class="op">=</span> <span class="cn">NULL</span>      <span class="co"># No parallel processing</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting pilot data preprocessing @ 2025-10-12 17:34:39.508177</span></span>
<span><span class="co">#&gt; Step 1: Computing gene expression information...</span></span>
<span><span class="co">#&gt; Start relative expression calculation @ 2025-10-12 17:34:39.535149</span></span>
<span><span class="co">#&gt; Finish relative expression calculation @ 2025-10-12 17:34:39.535818</span></span>
<span><span class="co">#&gt; Number of genes passing TPM threshold: 5</span></span>
<span><span class="co">#&gt; Start dispersion estimation (8 thread(s)) @ 2025-10-12 17:34:39.536077</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Starting computation</span></span>
<span><span class="co">#&gt;  - G (genes) = 5</span></span>
<span><span class="co">#&gt;  - C (cells) = 8</span></span>
<span><span class="co">#&gt; [gene 0] rel_expr = 0.0909091</span></span>
<span><span class="co">#&gt; [gene 0] t_0 = 0.0747664</span></span>
<span><span class="co">#&gt; [gene 0] theta_mle_row result = 401.014</span></span>
<span><span class="co">#&gt; [gene 1] rel_expr = 0.363636</span></span>
<span><span class="co">#&gt; [gene 1] t_0 = 1.06889</span></span>
<span><span class="co">#&gt; [gene 1] theta_mle_row result = 484.176</span></span>
<span><span class="co">#&gt; [gene 2] rel_expr = 0.181818</span></span>
<span><span class="co">#&gt; [gene 2] t_0 = 0.272921</span></span>
<span><span class="co">#&gt; [gene 2] theta_mle_row result = 468.498</span></span>
<span><span class="co">#&gt; [gene 3] rel_expr = 0.181818</span></span>
<span><span class="co">#&gt; [gene 3] t_0 = 0.272921</span></span>
<span><span class="co">#&gt; [gene 3] theta_mle_row result = 468.498</span></span>
<span><span class="co">#&gt; [gene 4] rel_expr = 0.181818</span></span>
<span><span class="co">#&gt; [gene 4] t_0 = 0.272921</span></span>
<span><span class="co">#&gt; [gene 4] theta_mle_row result = 468.498</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Done.</span></span>
<span><span class="co">#&gt; Finish dispersion estimation @ 2025-10-12 17:34:39.537431</span></span>
<span><span class="co">#&gt; Step 2: Estimating library parameters...</span></span>
<span><span class="co">#&gt; Completed pilot data preprocessing @ 2025-10-12 17:34:39.543179</span></span>
<span><span class="co">#&gt; Processed 5 genes</span></span>
<span><span class="co">#&gt; Library parameters: UMI_per_cell = 6, variation = 0.372</span></span>
<span><span class="co">#&gt; Mapping efficiency = 1</span></span>
<span></span>
<span><span class="co"># Process into pilot data format with targetd genes only, suitable for TAP-seq experimental design</span></span>
<span><span class="va">gene_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ENSG00000241860"</span>, <span class="st">"ENSG00000238009"</span>, <span class="st">"ENSG00000239945"</span><span class="op">)</span></span>
<span><span class="va">pilot_data_tapseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reference_data_processing.html">reference_data_processing</a></span><span class="op">(</span></span>
<span>  response_matrix <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>  read_umi_table <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">read_umi_table</span>,</span>
<span>  mapping_efficiency <span class="op">=</span> <span class="va">raw_data</span><span class="op">$</span><span class="va">mapping_efficiency</span>,</span>
<span>  gene_list <span class="op">=</span> <span class="va">gene_list</span>, <span class="co"># Restrict to specific genes</span></span>
<span>  TPM_thres <span class="op">=</span> <span class="fl">0</span>          <span class="co"># No expression threshold for filtering</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting pilot data preprocessing @ 2025-10-12 17:34:39.544034</span></span>
<span><span class="co">#&gt; Step 1: Computing gene expression information...</span></span>
<span><span class="co">#&gt; Start relative expression calculation @ 2025-10-12 17:34:39.567444</span></span>
<span><span class="co">#&gt; Finish relative expression calculation @ 2025-10-12 17:34:39.567663</span></span>
<span><span class="co">#&gt; Number of genes passing TPM threshold: 3</span></span>
<span><span class="co">#&gt; Start dispersion estimation (8 thread(s)) @ 2025-10-12 17:34:39.567919</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Starting computation</span></span>
<span><span class="co">#&gt;  - G (genes) = 3</span></span>
<span><span class="co">#&gt;  - C (cells) = 8</span></span>
<span><span class="co">#&gt; [gene 0] rel_expr = 0.5</span></span>
<span><span class="co">#&gt; [gene 0] t_0 = 1.33333</span></span>
<span><span class="co">#&gt; [gene 0] theta_mle_row result = 486.513</span></span>
<span><span class="co">#&gt; [gene 1] rel_expr = 0.25</span></span>
<span><span class="co">#&gt; [gene 1] t_0 = 0.5</span></span>
<span><span class="co">#&gt; [gene 1] theta_mle_row result = 475.754</span></span>
<span><span class="co">#&gt; [gene 2] rel_expr = 0.25</span></span>
<span><span class="co">#&gt; [gene 2] t_0 = 0.5</span></span>
<span><span class="co">#&gt; [gene 2] theta_mle_row result = 475.754</span></span>
<span><span class="co">#&gt; [theta_batch_cpp] Done.</span></span>
<span><span class="co">#&gt; Finish dispersion estimation @ 2025-10-12 17:34:39.568558</span></span>
<span><span class="co">#&gt; Step 2: Estimating library parameters...</span></span>
<span><span class="co">#&gt; Completed pilot data preprocessing @ 2025-10-12 17:34:39.57174</span></span>
<span><span class="co">#&gt; Processed 3 genes</span></span>
<span><span class="co">#&gt; Library parameters: UMI_per_cell = 7, variation = 0.366</span></span>
<span><span class="co">#&gt; Mapping efficiency = 0.727</span></span></code></pre></div>
<p><strong>Arguments:</strong></p>
<ul>
<li>
<code>response_matrix</code>: Gene-by-cell expression matrix from
Step 1 (or NULL if <code>h5_only = TRUE</code>)</li>
<li>
<code>read_umi_table</code>: QC data frame from Step 1</li>
<li>
<code>mapping_efficiency</code>: Mapping efficiency from Step 1</li>
<li>
<code>gene_list</code>: Optional character vector to restrict
analysis to specific genes</li>
<li>
<code>TPM_thres</code>: Threshold for filtering low-expression genes
in gene expression model (default: 0.1)</li>
<li>
<code>downsample_ratio</code>: Proportion of downsampling in library
saturation model fitting (default: 0.7)</li>
<li>
<code>D2_rough</code>: Rough prior value for library variation
parameter, it’s typically higher in TAP seq experiment (i.e. 0.8)
(default for perturbseq experiment: 0.3)</li>
<li>
<code>h5_only</code>: If <code>TRUE</code>, skips baseline
expression step to save time, useful when you’re trying to find sensible
hyperparameters for library model fitting (default: FALSE)</li>
<li>
<code>n_threads</code>: Number of parallel processing threads
(default: NULL for single-threaded)</li>
</ul>
<p><strong>Note</strong>: In practice, our function demonstrates
robustness to downsampling with different seeds and moderate
misspecification of the prior for the variation parameter
(<code>D2_rough</code>).</p>
</div>
<div class="section level3">
<h3 id="function-output-1">Function Output<a class="anchor" aria-label="anchor" href="#function-output-1"></a>
</h3>
<p>As for the output of <code>reference_data_processing</code>, the
relative expression is higher and the mapping efficiency is lower in the
TAP-seq example due to the change in normalization. The library
parameters are similar between the two toy examples, but it’s often not
the case in reality. If we use a real TAP-seq dataset, the variation
parameter in library_parameters would typically be higher (closer to 1)
than that in perturb-seq (around 0.3).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect structure of perturb-seq pilot data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pilot_data_perturbseq</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ baseline_expression_stats:'data.frame':   5 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ response_id        : chr [1:5] "ENSG00000243485" "ENSG00000238009" "ENSG00000239945" "ENSG00000241860" ...</span></span>
<span><span class="co">#&gt;   ..$ relative_expression: num [1:5] 0.0909 0.3636 0.1818 0.1818 0.1818</span></span>
<span><span class="co">#&gt;   ..$ expression_size    : num [1:5] 401 484 468 468 468</span></span>
<span><span class="co">#&gt;  $ library_parameters       :List of 2</span></span>
<span><span class="co">#&gt;   ..$ UMI_per_cell: num 6.12</span></span>
<span><span class="co">#&gt;   ..$ variation   : num 0.372</span></span>
<span><span class="co">#&gt;  $ mapping_efficiency       : num 1</span></span>
<span></span>
<span><span class="co"># Inspect structure of TAP-seq pilot data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pilot_data_tapseq</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ baseline_expression_stats:'data.frame':   3 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ response_id        : chr [1:3] "ENSG00000238009" "ENSG00000239945" "ENSG00000241860"</span></span>
<span><span class="co">#&gt;   ..$ relative_expression: num [1:3] 0.5 0.25 0.25</span></span>
<span><span class="co">#&gt;   ..$ expression_size    : num [1:3] 487 476 476</span></span>
<span><span class="co">#&gt;  $ library_parameters       :List of 2</span></span>
<span><span class="co">#&gt;   ..$ UMI_per_cell: num 6.82</span></span>
<span><span class="co">#&gt;   ..$ variation   : num 0.366</span></span>
<span><span class="co">#&gt;  $ mapping_efficiency       : num 0.727</span></span></code></pre></div>
<p><strong>Format of each output:</strong></p>
<ul>
<li>
<code>baseline_expression_stats</code>: Data frame with columns:
<ul>
<li>
<code>response_id</code>: Ensembl gene identifier</li>
<li>
<code>relative_expression</code>: Estimated relative expression
proportions for each gene, normalized to sum to 1 across all genes of
interest</li>
<li>
<code>expression_size</code>: Estimated dispersion (size) parameter
representing gene-specific expression variability</li>
</ul>
</li>
<li>
<code>library_parameters</code>: List with:
<ul>
<li>
<code>UMI_per_cell</code>: Estimated maximum UMI count per cell</li>
<li>
<code>variation</code>: Estimated PCR amplification variation
parameter</li>
</ul>
</li>
<li>
<code>mapping_efficiency</code>: Adjusted mapping efficiency,
accounting for the fraction of reads mapped to the genes of
interest</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="see-also">See Also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<ul>
<li>
<code><a href="../reference/reference_data_preprocessing_10x.html">?reference_data_preprocessing_10x</a></code>: Formal documentation
of <code>reference_data_preprocessing_10x</code>
</li>
<li>
<code><a href="../reference/reference_data_processing.html">?reference_data_processing</a></code>: Formal documentation of
<code>reference_data_processing</code>
</li>
<li>
<code><a href="../reference/obtain_qc_response_data.html">?obtain_qc_response_data</a></code>,
<code><a href="../reference/obtain_qc_read_umi_table.html">?obtain_qc_read_umi_table</a></code>, and
<code><a href="../reference/obtain_mapping_efficiency.html">?obtain_mapping_efficiency</a></code>: Documentation on obtaining each
component of the output in
<code>reference_data_preprocessing_10x</code>.</li>
<li>
<code><a href="../reference/obtain_expression_information.html">?obtain_expression_information</a></code>: Documentation on
fitting the negative binomial model in
<code>reference_data_processing</code>.</li>
<li>
<code><a href="../reference/library_computation.html">?library_computation</a></code>: Documentation on fitting the
sequencing saturation model in
<code>reference_data_processing</code>.</li>
<li>Vignette “Getting Started with PerturbPlan”: Overview of power
analysis workflow</li>
</ul>
</div>
<div class="section level2">
<h2 id="mathematical-details-of-the-models-used-in-step-2">Mathematical details of the models used in Step 2<a class="anchor" aria-label="anchor" href="#mathematical-details-of-the-models-used-in-step-2"></a>
</h2>
<p>In particular, we consider two models, one for modeling gene
expression and one for modeling read-UMI relationship.</p>
<div class="section level3">
<h3 id="negative-binomial-expression-model">Negative binomial expression model<a class="anchor" aria-label="anchor" href="#negative-binomial-expression-model"></a>
</h3>
<p>For each gene, the function fits a negative binomial (NB) model to
characterize the distribution of gene expression levels across
cells:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">gene_expression</mtext><mo>∼</mo><mtext mathvariant="normal">NB</mtext><mo stretchy="false" form="prefix">(</mo><mtext mathvariant="normal">mean</mtext><mo>=</mo><mtext mathvariant="normal">library_size</mtext><mo>×</mo><mtext mathvariant="normal">relative_expression</mtext><mo>,</mo><mtext mathvariant="normal">size</mtext><mo>=</mo><mtext mathvariant="normal">expression_size</mtext><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\text{gene_expression} \sim \text{NB}(\text{mean} = \text{library_size} \times \text{relative_expression}, \text{size} = \text{expression_size})</annotation></semantics></math></p>
<p>where</p>
<ul>
<li>
<code>gene_expression</code>: Number of observed UMIs for the gene
in each cell</li>
<li>
<code>library_size</code>: Number of observed UMIs per cell</li>
</ul>
<p>are the data to use, and</p>
<ul>
<li>
<code>relative_expression</code>: Relative expression level of the
gene (fitted parameter)</li>
<li>
<code>expression_size</code>: Dispersion parameter (small values
indicate high biological variability)</li>
</ul>
<p>are the fitted parameters.</p>
</div>
<div class="section level3">
<h3 id="read-umi-model">Read-UMI model<a class="anchor" aria-label="anchor" href="#read-umi-model"></a>
</h3>
<p>The function fits a saturation curve that relates mapped reads per
cell to observed UMIs per cell (<code>library_size</code>):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">library_size</mtext><mo>=</mo><mtext mathvariant="normal">UMI_per_cell</mtext><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi mathvariant="normal">exp</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><mfrac><mtext mathvariant="normal">mapped_reads_per_cell</mtext><mtext mathvariant="normal">UMI_per_cell</mtext></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><mtext mathvariant="normal">variation</mtext><mo>×</mo><mfrac><msup><mtext mathvariant="normal">mapped_reads_per_cell</mtext><mn>2</mn></msup><mrow><mn>2</mn><mo>×</mo><msup><mtext mathvariant="normal">UMI_per_cell</mtext><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{library_size} = \text{UMI_per_cell} \times \left(1 - \exp\left(-\frac{\text{mapped_reads_per_cell}}{\text{UMI_per_cell}}\right) \times \left(1 + \text{variation} \times \frac{\text{mapped_reads_per_cell}^2}{2 \times \text{UMI_per_cell}^2}\right)\right)</annotation></semantics></math></p>
<p>where</p>
<ul>
<li>
<code>mapped_reads_per_cell</code>: Number of mapped reads per
cell</li>
<li>
<code>library_size</code>: Number of observed UMIs per cell</li>
</ul>
<p>are the data used to fit the model, and</p>
<ul>
<li>
<code>UMI_per_cell</code>: Total UMI per cell obtained at sequencing
saturation</li>
<li>
<code>variation</code>: Variation parameter characterizing PCR
amplification bias (between 0 and 1)</li>
</ul>
<p>are the fitted parameters.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ziang Niu, Yihui He, Eugene Katsevich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
